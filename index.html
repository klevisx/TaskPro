<!DOCTYPE html>

<html lang="sq">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>TaskPro CRM</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<style>
    :root {
      --primary: #4262ff;
      --primary-light: #f0f2ff;
      --primary-dark: #3351e6;
      --secondary: #6c757d;
      --success: #00c875;
      --danger: #ff3e3e;
      --warning: #ffaa00;
      --info: #14aaf5;
      --light: #f8f9fa;
      --dark: #323338;
      --white: #ffffff;
      --gray: #e9ecef;
      --dark-gray: #495057;
      --border-radius: 8px;
      --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: var(--light);
      color: var(--dark);
      line-height: 1.6;
    }
    
    header { 
      background: var(--white); 
      color: var(--dark); 
      padding: 0.75rem 1rem;
      box-shadow: var(--box-shadow);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid var(--gray);
    }
    
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
    }
    
    .logo i {
      font-size: 1.8rem;
    }
    
    .user-menu {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--white);
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .user-avatar:hover {
      transform: scale(1.05);
    }
    
    nav { 
      display: flex; 
      background: var(--white); 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow-x: auto;
      padding: 0 1rem;
      border-bottom: 1px solid var(--gray);
    }
    
    nav button {
      flex: 0 0 auto;
      padding: 1rem 1.5rem;
      border: none;
      background: transparent;
      color: var(--secondary);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
      border-bottom: 3px solid transparent;
      white-space: nowrap;
      position: relative;
    }
    
    nav button:hover, nav button.active { 
      color: var(--primary); 
    }
    
    nav button.active:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary);
      border-radius: 3px 3px 0 0;
    }
    
    nav button i {
      margin-right: 8px;
    }
    
    .container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    
    section { 
      display: none; 
      animation: fadeIn 0.3s ease-in-out;
    }
    
    section.active { 
      display: block; 
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Dark Mode */
    body.dark { 
      background: #1a1a1a; 
      color: #e0e0e0; 
    }
    
    body.dark header {
      background: #2d2d2d;
      border-bottom-color: #444;
    }
    
    body.dark nav {
      background: #2d2d2d;
      border-bottom-color: #444;
    }
    
    body.dark nav button {
      color: #b0b0b0;
    }
    
    body.dark nav button:hover, 
    body.dark nav button.active {
      color: var(--primary);
    }
    
    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--border-radius);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(66, 98, 255, 0.2);
    }
    
    .btn-secondary {
      background: var(--white);
      color: var(--dark);
      border: 1px solid var(--gray);
    }
    
    .btn-secondary:hover {
      background: var(--light);
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      background: #e03535;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 62, 62, 0.2);
    }
    
    /* Task Views */
    .view-toggle {
      display: flex;
      margin: 1rem 0;
      border-radius: var(--border-radius);
      overflow: hidden;
      border: 1px solid var(--gray);
      width: fit-content;
    }
    
    .view-toggle button {
      padding: 0.5rem 1rem;
      border: none;
      background: var(--white);
      color: var(--secondary);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }
    
    .view-toggle button.active {
      background: var(--primary);
      color: white;
    }
    
    /* Task Cards */
    .taskCard {
      background: var(--white);
      padding: 1rem;
      margin: 0.5rem 0;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      transition: var(--transition);
      cursor: move;
      position: relative;
      border-left: 4px solid transparent;
    }
    
    .taskCard:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .taskCard.high { border-left-color: var(--danger); }
    .taskCard.medium { border-left-color: var(--warning); }
    .taskCard.low { border-left-color: var(--success); }
    
    .taskCard small { 
      display: block; 
      color: var(--secondary);
      font-size: 0.85rem;
    }
    
    .taskCard .task-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      opacity: 0;
      transition: var(--transition);
    }
    
    .taskCard:hover .task-actions {
      opacity: 1;
    }
    
    .taskCard .task-actions button {
      padding: 4px 8px;
      font-size: 0.8rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    /* Kanban Board */
    .kanban-container {
      display: flex;
      gap: 1.5rem;
      margin-top: 1rem;
      overflow-x: auto;
      padding-bottom: 1rem;
    }
    
    .kanban {
      flex: 1;
      min-width: 300px;
      padding: 1rem;
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      min-height: 400px;
      transition: var(--transition);
    }
    
    .kanban:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    
    .kanban-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--gray);
    }
    
    .kanban-header h3 {
      margin: 0;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .kanban-header .count {
      background: var(--gray);
      color: var(--dark);
      padding: 2px 8px;
      border-radius: 20px;
      font-size: 0.8rem;
    }
    
    /* Table View */
    .table-view {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: var(--white);
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--box-shadow);
    }
    
    .table-view th, .table-view td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--gray);
    }
    
    .table-view th {
      background: var(--primary-light);
      color: var(--primary);
      font-weight: 600;
    }
    
    .table-view tr:hover td {
      background: rgba(66, 98, 255, 0.05);
    }
    
    /* Forms */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .form-control {
      margin-bottom: 1rem;
    }
    
    .form-control label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .form-control input,
    .form-control select,
    .form-control textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--gray);
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
    }
    
    .form-control input:focus,
    .form-control select:focus,
    .form-control textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(66, 98, 255, 0.2);
    }
    
    /* Tags */
    .tag {
      background: var(--primary);
      color: white;
      padding: 3px 8px;
      margin: 0 2px;
      border-radius: 20px;
      font-size: 0.75rem;
      display: inline-block;
    }
    
    .tag-high { background: var(--danger); }
    .tag-medium { background: var(--warning); color: var(--dark); }
    .tag-low { background: var(--success); }
    
    /* Progress Bar */
    .progress-container {
      width: 100%;
      height: 8px;
      background: var(--gray);
      border-radius: 4px;
      margin: 0.5rem 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
      transition: width 0.3s;
    }
    
    /* Calendar */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .calendar-day {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 0.75rem;
      min-height: 100px;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
    }
    
    .calendar-day:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .calendar-day-header {
      font-weight: bold;
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--gray);
    }
    
    .calendar-day.today {
      background: var(--primary);
      color: white;
    }
    
    .calendar-day.today .calendar-day-header {
      border-bottom-color: rgba(255,255,255,0.3);
    }
    
    .calendar-task {
      font-size: 0.8rem;
      padding: 0.25rem;
      margin-bottom: 0.25rem;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }
    
    /* Dashboard Cards */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
    
    .dashboard-card {
      background: var(--white);
      padding: 1.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      text-align: center;
      transition: var(--transition);
    }
    
    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    
    .dashboard-card h3 {
      margin-top: 0;
      color: var(--secondary);
      font-size: 1rem;
    }
    
    .dashboard-card .value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary);
      margin: 0.5rem 0;
    }
    
    /* Projects */
    .projects-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
    
    .project-card {
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
      transition: var(--transition);
    }
    
    .project-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    
    .project-header {
      padding: 1rem;
      background: var(--primary-light);
      color: var(--primary);
      font-weight: 600;
    }
    
    .project-body {
      padding: 1rem;
    }
    
    .project-progress {
      margin: 1rem 0;
    }
    
    .project-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: var(--secondary);
    }
    
    /* Notifications */
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .kanban-container {
        flex-direction: column;
      }
      
      .kanban {
        min-width: 100%;
      }
      
      .header-container {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
      
      .user-menu {
        width: 100%;
        justify-content: flex-end;
      }
      
      .dashboard-cards {
        grid-template-columns: 1fr 1fr;
      }
      
      .calendar-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 480px) {
      .dashboard-cards {
        grid-template-columns: 1fr;
      }
      
      nav button {
        padding: 0.75rem;
        font-size: 0.9rem;
      }
      
      nav button i {
        margin-right: 0;
      }
      
      nav button span {
        display: none;
      }
    }
  

.taskCard, .project-card {
  font-size: 1rem;
  line-height: 1.6;
  padding: 1.25rem;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.taskCard:hover, .project-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 24px rgba(0,0,0,0.1);
}

.taskCard strong, .project-card h3 {
  font-size: 1.1rem;
  font-weight: 600;
}

.taskCard small, .project-card small {
  font-size: 0.95rem;
}

.taskCard .progress-container,
.project-card .progress-container {
  margin-top: 0.5rem;
}



/* Menu buttons font size */
nav button {
  font-size: 1.05rem !important;
  padding: 1.1rem 1.7rem !important;
}


/* Calendar visual fixes */
.calendar-grid {
  grid-template-columns: repeat(7, 1fr);
  gap: 0.5rem;
}

.calendar-day {
  min-height: 120px;
  font-size: 0.95rem;
  border: 1px solid var(--gray);
  position: relative;
}

.calendar-day-header {
  font-weight: 600;
  font-size: 1rem;
  margin-bottom: 0.5rem;
}

.calendar-task {
  background: var(--primary-light);
  color: var(--dark);
  border-left: 3px solid var(--primary);
  padding: 4px 6px;
  border-radius: 4px;
  margin-top: 4px;
  font-size: 0.85rem;
}

.calendar-day.empty {
  background: transparent;
  box-shadow: none;
  border: none;
}


.taskCard {
  font-size: 14px;
  padding: 10px 12px;
  border-radius: 8px;
  border-left: 4px solid #4a63f3;
  background-color: #f0f4ff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  cursor: pointer;
}
.taskCard.veryUrgent {
  border-left-color: #d9534f;
  background-color: #fff0f0;
}
.taskCard .priority-badge {
  color: white;
  background: #d9534f;
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 4px;
  float: right;
}
.modal {
  display: none;
  position: fixed;
  z-index: 999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
}
.modal-content {
  background: white;
  padding: 1rem;
  max-width: 500px;
  margin: 10% auto;
  border-radius: 8px;
}
.modal-close {
  float: right;
  cursor: pointer;
  color: red;
}


/* Sidebar menu font enhancement */
.sidebar a {
  font-size: 16px !important;
  font-weight: 600;
  padding: 10px 16px;
}

/* Section title headings */
section h2 {
  font-size: 20px;
  color: #333;
  margin-bottom: 12px;
  font-weight: bold;
}


.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:999; }
.modal-content {
  background:#fff; padding:20px; border-radius:8px; width:90%; max-width:500px;
  margin:10% auto; position:relative; box-shadow:0 2px 10px rgba(0,0,0,0.3);
}
.modal-close {
  position:absolute; right:10px; top:10px; font-size:20px; color:red; cursor:pointer;
}
</style>
<style>
body {
  font-family: 'Inter', sans-serif;
  background-color: #f6f8fb;
}
.sidebar {
  background-color: #ffffff;
  border-right: 1px solid #dee2e6;
}
.sidebar a {
  font-size: 16px;
  font-weight: 600;
  color: #333;
  padding: 12px 20px;
  border-radius: 8px;
  margin-bottom: 6px;
  display: block;
}
.sidebar a:hover, .sidebar a.active {
  background-color: #e6f0ff;
  color: #0d6efd;
}
.card {
  border-radius: 12px;
  border: none;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  margin-bottom: 20px;
}
.card-header {
  background-color: #ffffff;
  border-bottom: 1px solid #f0f0f0;
  font-weight: 600;
}
.btn {
  border-radius: 10px;
}
.badge {
  padding: 6px 12px;
  border-radius: 50px;
  font-size: 12px;
}
</style><style>
.kanban-board {
  display: flex;
  gap: 20px;
  margin-top: 20px;
  overflow-x: auto;
}
.kanban-column {
  flex: 1;
  background: #ffffff;
  border-radius: 12px;
  padding: 16px;
  min-width: 280px;
  box-shadow: 0 1px 6px rgba(0,0,0,0.07);
}
.kanban-column h5 {
  margin-bottom: 12px;
  font-weight: 600;
  color: #333;
}
.kanban-task {
  background: #f8f9fa;
  padding: 10px 12px;
  border-radius: 8px;
  margin-bottom: 10px;
  font-size: 14px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}
.kanban-task .badge {
  float: right;
}
</style><style>
#dashboard .card:hover {
  transform: scale(1.03);
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}
</style><style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 2rem;
      background: #f6f8fb;
    }
    h2 {
      margin-top: 0;
    }
    .btn {
      padding: 10px 16px;
      background: #4262ff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn:hover {
      background: #2e4eea;
    }

    /* ✅ Detyrat e Përditshme - Kanban Stil */
    .kanban-board {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .kanban-column {
      flex: 1;
      min-width: 280px;
      background-color: #ffffff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .kanban-column h5 {
      font-weight: 600;
      margin-bottom: 12px;
      color: #333;
      text-align: center;
    }

    .kanban-task {
      background-color: #f4f6fb;
      border-left: 4px solid #4262ff;
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: grab;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
      font-size: 14px;
    }

    .kanban-task:hover {
      background-color: #eaf0ff;
    }

    .kanban-task small {
      display: block;
      font-size: 12px;
      color: #555;
    }

    .task-dropzone {
      min-height: 200px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
      background: #fff;
      max-width: 450px;
      margin: 10% auto;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 14px;
      color: red;
      font-size: 20px;
      cursor: pointer;
    }

    .form-control {
      margin-bottom: 14px;
    }

    label {
      display: block;
      margin-bottom: 4px;
    }

    input, select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
  </style></head>
<body>
<header>
<div class="header-container">
<div class="logo">
<i class="fas fa-tasks"></i>
<span>TaskPro CRM</span>
</div>
<div class="user-menu">
<button class="btn btn-secondary" onclick="toggleDarkMode()" title="Ndrysho Temën">
<i class="fas fa-moon"></i>
</button>
<div class="user-avatar" title="User Profile">JD</div>
</div>
</div>
</header>
<nav>
<button class="active" data-en="Dashboard" data-sq="Dashboard" onclick="showSection('dashboard')">
<i class="fas fa-tachometer-alt"></i> <span data-en="Dashboard" data-sq="Dashboard">Dashboard</span>
</button>
<button onclick="showSection('projects')">
<i class="fas fa-project-diagram"></i> <span>Projektet</span>
</button>
<button data-en="Calendar" data-sq="Kalendari" onclick="showSection('calendar')">
<i class="far fa-calendar-alt"></i> <span data-en="Calendar" data-sq="Kalendari">Kalendari</span>
</button>
<button onclick="showSection('tasks')">
<i class="fas fa-tasks"></i> <span>Detyrat</span>
</button>
<button data-en="Team" data-sq="Ekipi" onclick="showSection('team')">
<i class="fas fa-users"></i> <span data-en="Team" data-sq="Ekipi">Ekipi</span>
</button>
<button data-en="Clients" data-sq="Klientët" onclick="showSection('crm')">
<i class="fas fa-address-book"></i> <span data-en="Clients" data-sq="Klientët">Klientët</span>
</button>
<button onclick="showSection('reports')">
<i class="fas fa-chart-bar"></i> <span data-en="Reports" data-sq="Raportet">Raportet</span>
<span class="notification-badge">3</span>
</button>
<button onclick="showSection('settings')">
<i class="fas fa-cog"></i> <span>Cilësimet</span>
</button>
<div data-en="🧠 My Assistant" data-sq="🧠 Asistenti Im" onclick="showSection('asistenti-personal')" style="padding:10px; cursor:pointer; font-weight:bold; background:#fff; border-left:5px solid #0d6efd; margin:5px 0; border-radius:8px;">🧠 Asistenti Im</div></nav>
<div class="container">
<section class="active" id="dashboard">
<div id="urgentPanel" style="background:#fff3cd; padding:15px; margin-bottom:20px; border-left:5px solid #f0ad4e;">
<h3 style="margin-top:0;">⚠️ Detyra Urgjente &amp; të VONUARA</h3>
<ul id="urgentTasksList" style="margin:0; padding-left:20px;"></ul>
</div>
<h2><i class="fas fa-tachometer-alt"></i> Përmbledhje</h2>
<div class="dashboard-cards">
<div class="dashboard-card">
<h3>Totali i Detyrave</h3>
<div class="value" id="totalTasks">0</div>
<small>Të gjitha detyrat</small>
</div>
<div class="dashboard-card">
<h3>Të Përfunduara</h3>
<div class="value" id="doneTasks">0</div>
<small>Detyrat e përfunduara</small>
</div>
<div class="dashboard-card">
<h3>Detyrat për Sot</h3>
<div class="value" id="todayTasks">0</div>
<small>Afati sot</small>
</div>
<div class="dashboard-card">
<h3>Klientë Aktivë</h3>
<div class="value" id="activeClients">0</div>
<small>Klientët aktivë</small>
</div>
</div>
<div style="margin-top: 2rem;">
<div style="display: flex; justify-content: space-between; align-items: center;">
<h3>Detyrat e Fundit</h3>
<button class="btn btn-secondary" onclick="showSection('tasks')">
<i class="fas fa-eye"></i> Shiko të gjitha
          </button>
</div>
<div class="kanban-container" id="recentTasks" style="gap: 0.5rem;">
<!-- Recent tasks will be loaded here -->
</div>
</div>
<div style="margin-top: 2rem;">
<div style="display: flex; justify-content: space-between; align-items: center;">
<h3>Detyrat për Sot</h3>
<button class="btn btn-secondary" onclick="showSection('calendar')">
<i class="fas fa-calendar-day"></i> Shiko kalendarin
          </button>
</div>
<div class="kanban-container" id="todayTasksList" style="gap: 0.5rem;">
<!-- Today's tasks will be loaded here -->
</div>
</div>
<h2 style="margin-top:2rem; color:#d9534f;">🔔 Detyrat e VONUARA</h2>
<div id="overdueTasksContainer" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:1rem;"></div>
<p id="noOverdueTasks" style="color:gray;"></p>
<div class="modal" id="taskModal">
<div class="modal-content">
<span class="modal-close" onclick="closeModal()">×</span>
<h3 id="modalTitle"></h3>
<p id="modalDesc"></p>
<small id="modalFooter"></small>
</div>
</div>
<h3 style="margin-top:30px;">📊 Progresi i Ekipit</h3>
<canvas height="180" id="teamProgressChart"></canvas>
<div class="card" id="clientStatsCard" style="border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.3s ease;">
<div class="card-header bg-info text-white">
    📊 Statistika për Klientët
  </div>
<div class="card-body">
<select class="form-control mb-3" id="clientStatsSelect" onchange="updateClientStats()">
<option value="Coca Cola">Coca Cola</option>
<option value="Telekom Albania">Telekom Albania</option>
<option value="Banka Credins">Banka Credins</option>
</select>
<ul>
<li><strong>📁 Projekte gjithsej:</strong> <span id="clientProjectCount">0</span></li>
<li><strong>✅ Detyra gjithsej:</strong> <span id="clientTaskCount">0</span></li>
<li><strong>⚠️ Detyra të vonuara:</strong> <span id="clientOverdueCount">0</span></li>
<li><strong>📈 Progres mesatar:</strong> <span id="clientAvgProgress">0%</span></li>
</ul>
<button onmouseout="this.style.backgroundColor='#3498db'" onmouseover="this.style.backgroundColor='#2980b9'" style="margin-top: 10px; display: block; width: 100%; background-color: #3498db; color: white; border: none; border-radius: 8px; padding: 6px 12px; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease;">Shiko Detajet</button></div>
</div>
</section><section id="mini-kanban" style="padding: 20px; background-color: #f9f9f9;"><h4 style="font-weight: bold; margin-bottom: 16px;">📌 Mini-Kanban i Detyrave</h4><div style="display: flex; gap: 20px; flex-wrap: wrap;"><div class="kanban-column" ondragover="allowDrop(event)" ondrop="drop(event)" style="flex: 1; min-width: 220px; background-color: #ecf0f1; padding: 16px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);"><h5 style="text-align: center; font-weight: 600; margin-bottom: 10px;">📝 Për të Nisur</h5><div style="background: white; padding: 8px; margin-bottom: 8px; border-radius: 8px; font-weight: 500;">Detyra 1</div><div draggable="true" id="task_1" ondragstart="drag(event)">Detyra 1</div><div draggable="true" id="task_2" ondragstart="drag(event)">Detyra 2</div><div draggable="true" id="task_3" ondragstart="drag(event)">Detyra 3</div></div><div class="kanban-column" ondragover="allowDrop(event)" ondrop="drop(event)" style="flex: 1; min-width: 220px; background-color: #f1c40f; padding: 16px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);"><h5 style="text-align: center; font-weight: 600; margin-bottom: 10px;">🚧 Në Progres</h5><div style="background: white; padding: 8px; margin-bottom: 8px; border-radius: 8px; font-weight: 500;">Detyra 1</div></div><div class="kanban-column" ondragover="allowDrop(event)" ondrop="drop(event)" style="flex: 1; min-width: 220px; background-color: #2ecc71; padding: 16px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);"><h5 style="text-align: center; font-weight: 600; margin-bottom: 10px;">✅ Përfunduar</h5><div style="background: white; padding: 8px; margin-bottom: 8px; border-radius: 8px; font-weight: 500;">Detyra 1</div></div></div></section><section id="mini-kanban" style="margin-top: 30px;"><h4 style="margin-bottom: 16px; font-weight: 700;">📌 Mini Kanban - Detyra</h4><div style="display: flex; gap: 16px;"><div style="flex: 1; background-color: #f4f6f8; padding: 12px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);"><h5 style="font-weight: 700; margin-bottom: 10px;">🟡 Planifikuar</h5><div style="background-color: white; padding: 8px 10px; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 14px;">Takim me klientin</div><div style="background-color: white; padding: 8px 10px; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 14px;">Blerje pajisjesh</div></div><div style="flex: 1; background-color: #f4f6f8; padding: 12px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);"><h5 style="font-weight: 700; margin-bottom: 10px;">🔵 Në Progres</h5><div style="background-color: white; padding: 8px 10px; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 14px;">Konfigurim sistemesh</div><div style="background-color: white; padding: 8px 10px; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 14px;">Testim</div></div><div style="flex: 1; background-color: #f4f6f8; padding: 12px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);"><h5 style="font-weight: 700; margin-bottom: 10px;">🟢 Përfunduar</h5><div style="background-color: white; padding: 8px 10px; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 14px;">Projektimi</div><div style="background-color: white; padding: 8px 10px; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 14px;">Draft oferte</div></div></div></section>
<section class="container" id="kanbanBoard">
<h4 class="mt-5 mb-3">📌 Detyrat - Pamja Kanban</h4>
<div class="kanban-board">
<div class="kanban-column">
<h5>🟡 Në Pritje</h5>
<div class="kanban-task">Konfigurim Server <span class="badge bg-warning" data-en="Priority" data-sq="Prioritet">Prioritet</span></div>
<div class="kanban-task">Planifikim Takimi</div>
</div>
<div class="kanban-column">
<h5>🔵 Në Zbatim</h5>
<div class="kanban-task">Zhvillim Modul CRM <span class="badge bg-info text-dark">Normal</span></div>
</div>
<div class="kanban-column">
<h5>🟢 E Përfunduar</h5>
<div class="kanban-task">Analizë Fillestare <span class="badge bg-success">✓</span></div>
</div>
</div>
</section>
<section id="projects">
<h2><i class="fas fa-project-diagram"></i> Projektet</h2>
<button class="btn btn-primary" onclick="showProjectModal()">
<i class="fas fa-plus"></i> Shto Projekt
      </button>
<div class="projects-grid" id="projectsGrid">
<!-- Projects will be loaded here -->
</div>
</section>
<section id="tasks">
<h2>📌 Detyrat e Përditshme</h2>
<div style="margin-bottom: 1rem;">
<label><strong>Filtro sipas përgjegjësit:</strong></label>
<select id="filterByPerson" onchange="renderDailyTasks()">
<option value="">Të gjithë</option>
</select>
<button class="btn" onclick="showTaskForm()" style="margin-left: 1rem;"><i class="fas fa-plus"></i> Shto Detyrë</button>
</div>
<div class="kanban-board" id="dailyKanban">
<div class="kanban-column" ondragover="allowDrop(event)" ondrop="dropTask(event, 'Planifikuar')">
<h5>🟡 Planifikuar</h5>
<div class="task-dropzone" id="daily-plan"></div>
</div>
<div class="kanban-column" ondragover="allowDrop(event)" ondrop="dropTask(event, 'Ne Proces')">
<h5>🔵 Në Proçes</h5>
<div class="task-dropzone" id="daily-process"></div>
</div>
<div class="kanban-column" ondragover="allowDrop(event)" ondrop="dropTask(event, 'Perfunduar')">
<h5>🟢 Përfunduar</h5>
<div class="task-dropzone" id="daily-done"></div>
</div>
</div>
<div class="modal" id="dailyTaskModal">
<div class="modal-content">
<span class="modal-close" onclick="closeTaskModal()">×</span>
<h3 id="modalTaskTitle">Shto Detyrë</h3>
<input id="editTaskId" type="hidden"/>
<div class="form-control">
<label>Titulli</label>
<input id="dailyTitle" placeholder="Shkruaj titullin" type="text"/>
</div>
<div class="form-control">
<label>Përgjegjësi</label>
<input id="dailyPerson" placeholder="Emri i përgjegjësit" type="text"/>
</div>
<div class="form-control">
<label>Statusi</label>
<select id="dailyStatus">
<option data-en="Planned" data-sq="Planifikuar" value="Planifikuar">Planifikuar</option>
<option data-en="In Progress" data-sq="Në Proçes" value="Ne Proces">Në Proçes</option>
<option data-en="Completed" data-sq="Përfunduar" value="Perfunduar">Përfunduar</option>
</select>
</div>
<button class="btn" onclick="saveDailyTask()">💾 Ruaj Detyrën</button>
</div>
</div>
<button class="btn btn-secondary" onclick="undoLastAction()">⏪ Kthehu Pas</button><button class="btn btn-secondary" onclick="exportActionHistory()">📁 Eksporto Historikun</button></section>
<section id="team">
<h2><i class="fas fa-users"></i> Menaxhimi i Ekipit</h2>
<div class="form-grid">
<div class="form-control">
<label for="teamName">Emri i Anëtarit</label>
<input id="teamName" placeholder="Emri i plotë" required="" type="text"/>
</div>
<div class="form-control">
<label for="teamStatus">Statusi</label>
<select id="teamStatus">
<option value="🟢">🟢 Aktiv</option>
<option value="🟡">🟡 Pushim</option>
<option value="🔴">🔴 Joaktiv</option>
</select>
</div>
<div class="form-control">
<label for="teamRole">Roli</label>
<input id="teamRole" placeholder="Pozicioni në ekip" type="text"/>
</div>
<div class="form-control">
<label for="teamEmail">Email</label>
<input id="teamEmail" placeholder="Emaili i anëtarit" type="email"/>
</div>
<div class="form-control">
<label for="teamPhone">Telefoni</label>
<input id="teamPhone" placeholder="Numri i telefonit" type="tel"/>
</div>
<div class="form-control">
<label for="teamSkills">Aftësitë</label>
<input id="teamSkills" placeholder="Aftësitë (ndarë me presje)" type="text"/>
</div>
</div>
<button class="btn btn-primary" onclick="handleTeamSubmit(event)">
<i class="fas fa-user-plus"></i> Shto Anëtar
      </button>
<div style="margin-top: 2rem;">
<h3>Lista e Ekipit</h3>
<div id="teamList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;"></div>
</div>
</section>
<section id="crm">
<h2><i class="fas fa-address-book"></i> Menaxhimi i Klientëve</h2>
<div class="form-grid">
<div class="form-control">
<label for="clientName">Emri i Klientit</label>
<input id="clientName" placeholder="Emri i kompanisë" required="" type="text"/>
</div>
<div class="form-control">
<label for="clientContact">Personi Kontaktues</label>
<input id="clientContact" placeholder="Emri i personit" type="text"/>
</div>
<div class="form-control">
<label for="clientPhone">Telefoni</label>
<input id="clientPhone" placeholder="Numri i telefonit" type="tel"/>
</div>
<div class="form-control">
<label for="clientEmail">Email</label>
<input id="clientEmail" placeholder="Emaili i klientit" type="email"/>
</div>
<div class="form-control">
<label for="clientStatus">Statusi</label>
<select id="clientStatus">
<option value="Aktiv">Aktiv</option>
<option value="Pasiv">Pasiv</option>
<option value="Potencial">Potencial</option>
</select>
</div>
<div class="form-control">
<label for="clientSource">Burimi</label>
<input id="clientSource" placeholder="Si e keni gjetur klientin?" type="text"/>
</div>
</div>
<button class="btn btn-primary" onclick="handleClientSubmit(event)">
<i class="fas fa-plus"></i> Shto Klient
      </button>
<div style="margin-top: 2rem;">
<h3>Lista e Klientëve</h3>
<div id="clientList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;"></div>
</div>
</section>
<section id="reports">
<h2 data-en="Reports" data-sq="Raportet"><i class="fas fa-chart-bar"></i> Raportet</h2>
<div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
<button class="btn btn-primary" onclick="generateJSON()">
<i class="fas fa-file-export"></i> Shkarko JSON
        </button>
<button class="btn btn-primary" onclick="generatePDF()">
<i class="fas fa-file-pdf"></i> Shkarko PDF
        </button>
<button class="btn btn-secondary" onclick="showCharts()">
<i class="fas fa-chart-pie"></i> Shfaq Grafikët
        </button>
</div>
<div class="dashboard-cards" id="reportStats">
<div class="dashboard-card">
<h3>Detyrat e Përfunduara</h3>
<div class="value" id="completedTasks">0</div>
<small>Këtë muaj</small>
</div>
<div class="dashboard-card">
<h3>Detyrat e Vonuara</h3>
<div class="value" id="overdueTasks">0</div>
<small>Këtë muaj</small>
</div>
<div class="dashboard-card">
<h3>Produktiviteti</h3>
<div class="value" id="productivity">0%</div>
<small>Ekipi</small>
</div>
<div class="dashboard-card">
<h3>Klientë të Rinj</h3>
<div class="value" id="newClients">0</div>
<small>Këtë muaj</small>
</div>
</div>
<div id="chartsContainer" style="margin-top: 2rem; display: none;">
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
<div>
<h3>Shpërndarja e Detyrave sipas Statusit</h3>
<canvas height="300" id="statusChart"></canvas>
</div>
<div>
<h3>Shpërndarja e Detyrave sipas Prioritetit</h3>
<canvas height="300" id="priorityChart"></canvas>
</div>
<div>
<h3>Detyrat e Përfunduara (30 ditët e fundit)</h3>
<canvas height="300" id="timelineChart"></canvas>
</div>
<div>
<h3>Shpërndarja e Klientëve</h3>
<canvas height="300" id="clientsChart"></canvas>
</div>
</div>
</div>
<div style="margin-top: 2rem;">
<h3>Numri i Detyrave për çdo Projekt</h3>
<canvas height="300" id="projectTaskChart"></canvas>
</div></section>
<section id="calendar">
<h2 data-en="Calendar" data-sq="Kalendari"><i class="far fa-calendar-alt"></i> Kalendari</h2>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
<div>
<button class="btn btn-secondary" onclick="prevMonth()">
<i class="fas fa-chevron-left"></i> Muaji i Kaluar
          </button>
<button class="btn btn-secondary" onclick="nextMonth()">
            Muaji i Ardhshem <i class="fas fa-chevron-right"></i>
</button>
</div>
<h3 id="currentMonth" style="margin: 0;"></h3>
<button class="btn btn-primary" onclick="goToToday()">
<i class="fas fa-calendar-day"></i> Sot
        </button>
</div>
<div class="calendar-grid" id="calendarGrid">
<div class="calendar-day">
<div class="calendar-day-header">E Hënë</div>
</div>
<div class="calendar-day">
<div class="calendar-day-header">E Martë</div>
</div>
<div class="calendar-day">
<div class="calendar-day-header">E Mërkurë</div>
</div>
<div class="calendar-day">
<div class="calendar-day-header">E Enjte</div>
</div>
<div class="calendar-day">
<div class="calendar-day-header">E Premte</div>
</div>
<div class="calendar-day">
<div class="calendar-day-header">E Shtunë</div>
</div>
<div class="calendar-day">
<div class="calendar-day-header">E Diel</div>
</div>
</div>
<div class="card mt-4" id="advancedCalendar">
<div class="card-header bg-primary text-white">
    📆 Kalendari i Detyrave (Ngjyrosur sipas statusit)
  </div>
<div class="card-body" id="calendarTaskList">
<ul class="list-group" id="calendarList"></ul>
</div>
</div>
<div class="text-end mt-3">
<button class="btn btn-danger" onclick="exportTasksToPDF()">📄 Eksporto Detyrat në PDF</button>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">

function updateClientSelect() {
  const clientDropdown = document.getElementById("projectClient");
  if (!clientDropdown) return;
  clientDropdown.innerHTML = `<option value="">Zgjidh klientin</option>`;
  clients.forEach(client => {
    const option = document.createElement("option");
    option.value = client.name;
    option.textContent = client.name;
    clientDropdown.appendChild(option);
  });
}



function handleClientSubmit(e) {
  e.preventDefault();
  const client = {
    name: document.getElementById("clientName").value,
    contact: document.getElementById("clientContact").value,
    phone: document.getElementById("clientPhone").value,
    email: document.getElementById("clientEmail").value,
    status: document.getElementById("clientStatus").value,
    source: document.getElementById("clientSource").value
  };

  clients.push(client);
  localStorage.setItem("clients", JSON.stringify(clients));
  renderClients();
  alert("Klienti u shtua me sukses!");
}

</script>
<script>
async function exportTasksToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text("Raport Detyrash", 15, 20);
  let y = 30;

  tasks.forEach((task, i) => {
    doc.text(`${i + 1}. ${task.title}`, 15, y);
    doc.setFontSize(10);
    doc.text(`Status: ${task.status} | Afati: ${task.deadline} | Përgjegjës: ${task.assignee || "—"}`, 15, y + 6);
    doc.setFontSize(14);
    y += 20;
    if (y > 270) {
      doc.addPage();
      y = 20;
    }
  });

  doc.save("Raport_Detyrash.pdf");
}


function updateClientSelect() {
  const clientDropdown = document.getElementById("projectClient");
  if (!clientDropdown) return;
  clientDropdown.innerHTML = `<option value="">Zgjidh klientin</option>`;
  clients.forEach(client => {
    const option = document.createElement("option");
    option.value = client.name;
    option.textContent = client.name;
    clientDropdown.appendChild(option);
  });
}



function handleClientSubmit(e) {
  e.preventDefault();
  const client = {
    name: document.getElementById("clientName").value,
    contact: document.getElementById("clientContact").value,
    phone: document.getElementById("clientPhone").value,
    email: document.getElementById("clientEmail").value,
    status: document.getElementById("clientStatus").value,
    source: document.getElementById("clientSource").value
  };

  clients.push(client);
  localStorage.setItem("clients", JSON.stringify(clients));
  renderClients();
  alert("Klienti u shtua me sukses!");
}

</script>
</section>
<section id="settings"><label>🌐 Language / Gjuha:</label><select onchange="setLanguage(this.value)"><option value="sq">Shqip</option><option value="en">English</option></select>
<h2><i class="fas fa-cog"></i> Cilësimet</h2>
<div class="form-grid">
<div class="form-control">
<label for="language">Gjuha e Aplikacionit</label>
<select id="language">
<option value="sq">Shqip</option>
<option value="en">English</option>
</select>
</div>
<div class="form-control">
<label for="theme">Tema</label>
<select id="theme" onchange="changeTheme(this.value)">
<option value="light">E Çelët</option>
<option value="dark">E Errët</option>
<option value="system">Sistemi</option>
</select>
</div>
<div class="form-control">
<label for="notifications">Njoftimet</label>
<select id="notifications">
<option value="enabled">Aktivizo</option>
<option value="disabled">Çaktivizo</option>
</select>
</div>
<div class="form-control">
<label for="timezone">Zona Kohore</label>
<select id="timezone">
<option value="Europe/Tirane">(GMT+1) Europe/Tirane</option>
<option value="UTC">(GMT+0) UTC</option>
</select>
</div>
</div>
<div style="margin-top: 2rem;">
<h3>Eksporto të Dhënat</h3>
<button class="btn btn-secondary" onclick="generateJSON()">
<i class="fas fa-file-export"></i> Eksporto si JSON
        </button>
<button class="btn btn-secondary" onclick="generateCSV()" style="margin-left: 1rem;">
<i class="fas fa-file-csv"></i> Eksporto si CSV
        </button>
</div>
<div style="margin-top: 2rem;">
<h3>Rreziku</h3>
<button class="btn btn-danger" onclick="clearAll()">
<i class="fas fa-trash-alt"></i> Fshi të gjitha të dhënat
        </button>
<small style="display: block; margin-top: 0.5rem; color: var(--danger);">Ky veprim nuk mund të zhbëhet!</small>
</div>
</section>
</div>
<!-- Project Modal -->
<div id="projectModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
<div style="background: var(--white); padding: 2rem; border-radius: var(--border-radius); width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
<h2 style="margin-top: 0;"><i class="fas fa-project-diagram"></i> Shto Projekt të Ri</h2>
<div class="form-grid">
<div class="form-control">
<label for="projectName">Emri i Projektit</label>
<input id="projectName" placeholder="Emri i projektit" required="" type="text"/>
</div>
<div class="form-group">
<label for="projectClient">Klienti</label>
<select class="form-control" id="projectClient">
<option value="">Zgjidh klientin</option>
</select>
</div>
<div class="form-control">
<label for="projectDescription">Përshkrimi</label>
<textarea id="projectDescription" placeholder="Përshkrimi i projektit" rows="3"></textarea>
</div>
<div class="form-control">
<label for="projectStart">Data e Fillimit</label>
<input id="projectStart" required="" type="date"/>
</div>
<div class="form-control">
<label for="projectEnd">Data e Përfundimit</label>
<input id="projectEnd" required="" type="date"/>
</div>
<div class="form-control">
<label for="projectManager">Menaxheri i Projektit</label>
<select id="projectManager">
<option value="">Zgjidh menaxherin</option>
<!-- Team members will be loaded here -->
</select>
</div>
<div class="form-control">
<label for="projectStatus">Statusi</label>
<select id="projectStatus">
<option data-en="Planned" data-sq="Planifikuar" value="Planifikuar">Planifikuar</option>
<option value="Ne Proces">Në Proces</option>
<option data-en="Completed" data-sq="Përfunduar" value="Perfunduar">Përfunduar</option>
<option value="I Pezulluar">I Pezulluar</option>
</select>
</div>
<div class="form-control">
<label for="projectColor">Ngjyra</label>
<input id="projectColor" type="color" value="#4262ff"/>
</div>
</div>
<div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem;">
<button class="btn btn-secondary" onclick="hideProjectModal()">
<i class="fas fa-times"></i> Anulo
        </button>
<button class="btn btn-primary" onclick="saveProject()">
<i class="fas fa-save"></i> Ruaj Projektin
        </button>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js">

function updateClientSelect() {
  const clientDropdown = document.getElementById("projectClient");
  if (!clientDropdown) return;
  clientDropdown.innerHTML = `<option value="">Zgjidh klientin</option>`;
  clients.forEach(client => {
    const option = document.createElement("option");
    option.value = client.name;
    option.textContent = client.name;
    clientDropdown.appendChild(option);
  });
}



function handleClientSubmit(e) {
  e.preventDefault();
  const client = {
    name: document.getElementById("clientName").value,
    contact: document.getElementById("clientContact").value,
    phone: document.getElementById("clientPhone").value,
    email: document.getElementById("clientEmail").value,
    status: document.getElementById("clientStatus").value,
    source: document.getElementById("clientSource").value
  };

  clients.push(client);
  localStorage.setItem("clients", JSON.stringify(clients));
  renderClients();
  alert("Klienti u shtua me sukses!");
}

</script>
<script>
  // Initialize data
  let tasks = JSON.parse(localStorage.getItem("tasks")) || [];
  let team = JSON.parse(localStorage.getItem("team")) || [];
  let clients = JSON.parse(localStorage.getItem("clients")) || [];
  let projects = JSON.parse(localStorage.getItem("projects")) || [];
  let currentMonth = new Date().getMonth();
  let currentYear = new Date().getFullYear();

  // DOM Content Loaded
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize forms
    document.getElementById('progress').addEventListener('input', function() {
      const value = this.value;
      document.getElementById('progressBar').style.width = `${value}%`;
      document.getElementById('progressValue').textContent = `${value}%`;
    });
    
    // Load team members into select dropdowns
    updateTeamSelects();
    
    // Initial renders
    renderTasks();
    renderTeam();
    renderClients();
    renderProjects();
    updateDashboard();
    generateCalendar();
    
    // Check for saved theme preference
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark');
      document.getElementById('theme').value = 'dark';
    }
    
    // Check system preference
    if (localStorage.getItem('theme') === 'system') {
      changeTheme('system');
    }
  });

  // Task Functions
  async function handleTaskSubmit(e) {
    e.preventDefault();
    const fileInput = document.getElementById('attachment');
    let fileData = null;
    
    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      fileData = await toBase64(file);
    }
    
    const task = {
      id: Date.now(),
      title: document.getElementById('title').value,
      description: document.getElementById('description').value,
      deadline: document.getElementById('deadline').value,
      assigned: document.getElementById('assigned').value,
      status: document.getElementById('status').value,
      priority: document.getElementById('priority').value,
      progress: document.getElementById('progress').value,
      tags: document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t),
      file: fileData,
      createdAt: new Date().toISOString()
    };
    
    tasks.push(task);
    saveTasks();
    e.target.reset();
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressValue').textContent = '0%';
  }

  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
    });
  }

  function saveTasks() {
    localStorage.setItem("tasks", JSON.stringify(tasks));
    renderTasks();
    updateDashboard();
    generateCalendar();
  }

  function renderTasks() {
    // Kanban view
    const plan = document.getElementById("planTasks");
    const process = document.getElementById("processTasks");
    const done = document.getElementById("doneTasks");
    plan.innerHTML = process.innerHTML = done.innerHTML = "";

    // Update counts
    const planCount = tasks.filter(t => t.status === "Planifikuar").length;
    const processCount = tasks.filter(t => t.status === "Ne Proces").length;
    const doneCount = tasks.filter(t => t.status === "Perfunduar").length;
    
    document.getElementById("planCount").textContent = planCount;
    document.getElementById("processCount").textContent = processCount;
    document.getElementById("doneCount").textContent = doneCount;

    // Table view
    const tableBody = document.getElementById("tasksTableBody");
    tableBody.innerHTML = "";

    tasks.forEach(task => {
      // Kanban cards
      const div = document.createElement("div");
      div.className = `taskCard ${task.priority.toLowerCase()}`;
      div.draggable = true;
      div.dataset.id = task.id;
      div.ondragstart = ev => ev.dataTransfer.setData("text", task.id);
      
      // Determine tag class based on priority
      let priorityClass = '';
      if (task.priority === "Larte") priorityClass = 'tag-high';
      else if (task.priority === "Mesatar") priorityClass = 'tag-medium';
      else if (task.priority === "Ulet") priorityClass = 'tag-low';
      
      const tagHTML = task.tags.map(t => `<span class='tag'>${t}</span>`).join(' ');
      const fileBtn = task.file ? `<button class="file-btn" onclick="openFile('${task.file}')"><i class="fas fa-paperclip"></i> Dokument</button>` : "";
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between;">
          <strong>${task.title}</strong>
          <span class="tag ${priorityClass}">${task.priority}</span>
        </div>
        <small>Përgjegjës: ${task.assigned}</small>
        <small>Afati: ${formatDate(task.deadline)}</small>
        <div class="progress-container">
          <div class="progress-bar" style="width: ${task.progress}%"></div>
        </div>
        <small>Status: ${task.status} | Progresi: ${task.progress}%</small>
        ${tagHTML ? `<div style="margin-top: 0.5rem;">${tagHTML}</div>` : ''}
        <div class="task-actions">
          ${fileBtn}
          <button class="edit-btn" onclick="editTask(${task.id})"><i class="fas fa-edit"></i> Ndrysho</button>
          <button class="delete-btn" onclick="deleteTask(${task.id})"><i class="fas fa-trash-alt"></i> Fshi</button>
        </div>
      `;

      if (task.status === "Planifikuar") plan.appendChild(div);
      else if (task.status === "Ne Proces") process.appendChild(div);
      else if (task.status === "Perfunduar") done.appendChild(div);
      
      // Table rows
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${task.title}</td>
        <td>${task.assigned}</td>
        <td>${formatDate(task.deadline)}</td>
        <td>${task.status}</td>
        <td><span class="tag ${priorityClass}">${task.priority}</span></td>
        <td>
          <div class="progress-container">
            <div class="progress-bar" style="width: ${task.progress}%"></div>
          </div>
          <small>${task.progress}%</small>
        </td>
        <td>
          <button class="edit-btn" onclick="editTask(${task.id})"><i class="fas fa-edit"></i></button>
          <button class="delete-btn" onclick="deleteTask(${task.id})"><i class="fas fa-trash-alt"></i></button>
        </td>
      `;
      tableBody.appendChild(row);
    });

    // Render recent tasks for dashboard
    const recentTasksContainer = document.getElementById("recentTasks");
    recentTasksContainer.innerHTML = "";
    
    const sortedTasks = [...tasks].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
    
    sortedTasks.forEach(task => {
      const taskDiv = document.createElement("div");
      taskDiv.className = "taskCard";
      taskDiv.style.minWidth = "250px";
      
      let priorityClass = '';
      if (task.priority === "Larte") priorityClass = 'tag-high';
      else if (task.priority === "Mesatar") priorityClass = 'tag-medium';
      else if (task.priority === "Ulet") priorityClass = 'tag-low';
      
      taskDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between;">
          <strong>${task.title}</strong>
          <span class="tag ${priorityClass}">${task.priority}</span>
        </div>
        <small>Përgjegjës: ${task.assigned}</small>
        <small>Afati: ${formatDate(task.deadline)}</small>
        <div class="progress-container">
          <div class="progress-bar" style="width: ${task.progress}%"></div>
        </div>
        <small>Status: ${task.status} | Progresi: ${task.progress}%</small>
      `;
      
      recentTasksContainer.appendChild(taskDiv);
    });
    
    // Render today's tasks for dashboard
    const todayTasksContainer = document.getElementById("todayTasksList");
    todayTasksContainer.innerHTML = "";
    
    const today = new Date().toISOString().split('T')[0];
    const todayTasks = tasks.filter(t => t.deadline === today).slice(0, 5);
    
    todayTasks.forEach(task => {
      const taskDiv = document.createElement("div");
      taskDiv.className = "taskCard";
      taskDiv.style.minWidth = "250px";
      
      let priorityClass = '';
      if (task.priority === "Larte") priorityClass = 'tag-high';
      else if (task.priority === "Mesatar") priorityClass = 'tag-medium';
      else if (task.priority === "Ulet") priorityClass = 'tag-low';
      
      taskDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between;">
          <strong>${task.title}</strong>
          <span class="tag ${priorityClass}">${task.priority}</span>
        </div>
        <small>Përgjegjës: ${task.assigned}</small>
        <small>Afati: Sot</small>
        <div class="progress-container">
          <div class="progress-bar" style="width: ${task.progress}%"></div>
        </div>
        <small>Status: ${task.status} | Progresi: ${task.progress}%</small>
      `;
      
      todayTasksContainer.appendChild(taskDiv);
    });
  }

  function editTask(id) {
    const task = tasks.find(t => t.id === id);
    if (!task) return;
    
    document.getElementById("title").value = task.title;
    document.getElementById("description").value = task.description;
    document.getElementById("deadline").value = task.deadline;
    document.getElementById("assigned").value = task.assigned;
    document.getElementById("status").value = task.status;
    document.getElementById("priority").value = task.priority;
    document.getElementById("progress").value = task.progress;
    document.getElementById("progressBar").style.width = `${task.progress}%`;
    document.getElementById("progressValue").textContent = `${task.progress}%`;
    document.getElementById("tags").value = task.tags.join(", ");
    
    // Remove the task being edited
    tasks = tasks.filter(t => t.id !== id);
    saveTasks();
    
    // Scroll to form
    document.getElementById("title").focus();
  }

  function deleteTask(id) {
    if (confirm("Jeni i sigurt që dëshironi të fshini këtë detyrë?")) {
      tasks = tasks.filter(t => t.id !== id);
      saveTasks();
    }
  }

  function filterTasks() {
    const statusFilter = document.getElementById("filterStatus").value;
    const personFilter = document.getElementById("filterPerson").value;
    const priorityFilter = document.getElementById("filterPriority").value;
    
    let filteredTasks = [...tasks];
    
    if (statusFilter) {
      filteredTasks = filteredTasks.filter(t => t.status === statusFilter);
    }
    
    if (personFilter) {
      filteredTasks = filteredTasks.filter(t => t.assigned === personFilter);
    }
    
    if (priorityFilter) {
      filteredTasks = filteredTasks.filter(t => t.priority === priorityFilter);
    }
    
    // Temporarily replace tasks with filtered ones
    const originalTasks = tasks;
    tasks = filteredTasks;
    renderTasks();
    tasks = originalTasks;
  }
  
  function resetFilters() {
    document.getElementById("filterStatus").value = "";
    document.getElementById("filterPerson").value = "";
    document.getElementById("filterPriority").value = "";
    renderTasks();
  }

  // Drag and Drop Functions
  function allowDrop(ev) {
    ev.preventDefault();
  }

  function drop(ev) {
    ev.preventDefault();
    const taskId = parseInt(ev.dataTransfer.getData("text"));
    const newStatus = ev.target.closest(".kanban").dataset.status;
    
    const taskIndex = tasks.findIndex(t => t.id === taskId);
    if (taskIndex !== -1) {
      tasks[taskIndex].status = newStatus;
      saveTasks();
    }
  }

  // Team Functions
  function handleTeamSubmit(e) {
    e.preventDefault();
    
    const member = {
      id: Date.now(),
      name: document.getElementById("teamName").value,
      status: document.getElementById("teamStatus").value,
      role: document.getElementById("teamRole").value,
      email: document.getElementById("teamEmail").value,
      phone: document.getElementById("teamPhone").value,
      skills: document.getElementById("teamSkills").value.split(',').map(s => s.trim()).filter(s => s),
      joined: new Date().toISOString()
    };
    
    team.push(member);
    saveTeam();
    e.target.reset();
  }

  function saveTeam() {
    localStorage.setItem("team", JSON.stringify(team));
    renderTeam();
    updateDashboard();
    updateTeamSelects();
  }
  
  function updateTeamSelects() {
    const assignedSelect = document.getElementById("assigned");
    const filterPersonSelect = document.getElementById("filterPerson");
    const projectManagerSelect = document.getElementById("projectManager");
    
    // Clear existing options except first one
    while (assignedSelect.options.length > 1) assignedSelect.remove(1);
    while (filterPersonSelect.options.length > 1) filterPersonSelect.remove(1);
    while (projectManagerSelect.options.length > 1) projectManagerSelect.remove(1);
    
    // Add team members
    team.forEach(member => {
      const option = document.createElement("option");
      option.value = member.name;
      option.textContent = member.name;
      
      assignedSelect.appendChild(option.cloneNode(true));
      filterPersonSelect.appendChild(option.cloneNode(true));
      projectManagerSelect.appendChild(option.cloneNode(true));
    });
  }

  function renderTeam() {
    const teamList = document.getElementById("teamList");
    teamList.innerHTML = "";
    
    team.forEach(member => {
      const div = document.createElement("div");
      div.className = "taskCard";
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0;">${member.name}</h3>
          <span style="font-size: 1.5rem;">${member.status}</span>
        </div>
        <small>Roli: ${member.role || 'Nuk është përcaktuar'}</small>
        <small>Email: ${member.email || 'Nuk është përcaktuar'}</small>
        <small>Telefon: ${member.phone || 'Nuk është përcaktuar'}</small>
        ${member.skills && member.skills.length > 0 ? 
          `<small>Aftësitë: ${member.skills.map(s => `<span class="tag">${s}</span>`).join(' ')}</small>` : ''}
        <small>Anëtar që: ${formatDate(member.joined)}</small>
        <div class="task-actions" style="margin-top: 0.5rem;">
          <button class="edit-btn" onclick="editTeamMember(${member.id})"><i class="fas fa-edit"></i> Ndrysho</button>
          <button class="delete-btn" onclick="deleteTeamMember(${member.id})"><i class="fas fa-trash-alt"></i> Fshi</button>
        </div>
      `;
      
      teamList.appendChild(div);
    });
  }

  function editTeamMember(id) {
    const member = team.find(m => m.id === id);
    if (!member) return;
    
    document.getElementById("teamName").value = member.name;
    document.getElementById("teamStatus").value = member.status;
    document.getElementById("teamRole").value = member.role;
    document.getElementById("teamEmail").value = member.email;
    document.getElementById("teamPhone").value = member.phone;
    document.getElementById("teamSkills").value = member.skills ? member.skills.join(", ") : "";
    
    // Remove the member being edited
    team = team.filter(m => m.id !== id);
    saveTeam();
    
    // Scroll to form
    document.getElementById("teamName").focus();
  }

  function deleteTeamMember(id) {
    if (confirm("Jeni i sigurt që dëshironi të fshini këtë anëtar të ekipit?")) {
      team = team.filter(m => m.id !== id);
      saveTeam();
    }
  }

  // Client Functions
  function handleClientSubmit(e) {
    e.preventDefault();
    
    const client = {
      id: Date.now(),
      name: document.getElementById("clientName").value,
      contact: document.getElementById("clientContact").value,
      phone: document.getElementById("clientPhone").value,
      email: document.getElementById("clientEmail").value,
      status: document.getElementById("clientStatus").value,
      source: document.getElementById("clientSource").value,
      added: new Date().toISOString()
    };
    
    clients.push(client);
    saveClients();
    e.target.reset();
  }

  function saveClients() {
    localStorage.setItem("clients", JSON.stringify(clients));
    renderClients();
    updateDashboard();
  }

  function renderClients() {
    const clientList = document.getElementById("clientList");
    clientList.innerHTML = "";
    
    clients.forEach(client => {
      const div = document.createElement("div");
      div.className = "taskCard";
      
      let statusClass = '';
      if (client.status === "Aktiv") statusClass = 'tag';
      else if (client.status === "Pasiv") statusClass = 'tag-medium';
      else if (client.status === "Potencial") statusClass = 'tag-high';
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0;">${client.name}</h3>
          <span class="${statusClass}">${client.status}</span>
        </div>
        <small>Kontakt: ${client.contact || 'Nuk është përcaktuar'}</small>
        <small>Telefon: ${client.phone || 'Nuk është përcaktuar'}</small>
        <small>Email: ${client.email || 'Nuk është përcaktuar'}</small>
        ${client.source ? `<small>Burimi: ${client.source}</small>` : ''}
        <small>Shtuar më: ${formatDate(client.added)}</small>
        <div class="task-actions" style="margin-top: 0.5rem;">
          <button class="edit-btn" onclick="editClient(${client.id})"><i class="fas fa-edit"></i> Ndrysho</button>
          <button class="delete-btn" onclick="deleteClient(${client.id})"><i class="fas fa-trash-alt"></i> Fshi</button>
        </div>
      `;
      
      clientList.appendChild(div);
    });
  }

  function editClient(id) {
    const client = clients.find(c => c.id === id);
    if (!client) return;
    
    document.getElementById("clientName").value = client.name;
    document.getElementById("clientContact").value = client.contact;
    document.getElementById("clientPhone").value = client.phone;
    document.getElementById("clientEmail").value = client.email;
    document.getElementById("clientStatus").value = client.status;
    document.getElementById("clientSource").value = client.source || '';
    
    // Remove the client being edited
    clients = clients.filter(c => c.id !== id);
    saveClients();
    
    // Scroll to form
    document.getElementById("clientName").focus();
  }

  function deleteClient(id) {
    if (confirm("Jeni i sigurt që dëshironi të fshini këtë klient?")) {
      clients = clients.filter(c => c.id !== id);
      saveClients();
    }
  }

  // Project Functions
  function showProjectModal() {
  updateClientSelect();
  document.getElementById("projectModal").style.display = "flex";
}
  
  function hideProjectModal() {
    document.getElementById("projectModal").style.display = "none";
  }
  
  function saveProject() {
    const project = {
      id: Date.now(),
      name: document.getElementById("projectName").value,
      description: document.getElementById("projectDescription").value,
      start: document.getElementById("projectStart").value,
      end: document.getElementById("projectEnd").value,
      manager: document.getElementById("projectManager").value,
      status: document.getElementById("projectStatus").value,
      color: document.getElementById("projectColor").value,
      createdAt: new Date().toISOString()
    };
    
    projects.push(project);
    saveProjects();
    hideProjectModal();
    document.getElementById("projectForm").reset();
  }
  
  function saveProjects() {
    localStorage.setItem("projects", JSON.stringify(projects));
    renderProjects();
  }
  
  function renderProjects() {
    const projectsGrid = document.getElementById("projectsGrid");
    projectsGrid.innerHTML = "";
    
    projects.forEach(project => {
      const projectDiv = document.createElement("div");
      projectDiv.className = "project-card";
      projectDiv.style.borderTop = `4px solid ${project.color}`;
      
      // Calculate progress (simple random for demo)
      const progress = Math.floor(Math.random() * 100);
      
      projectDiv.innerHTML = `
        <div class="project-header">
          <h3>${project.name}</h3>
        </div>
        <div class="project-body">
          <p>${project.description || 'Nuk ka përshkrim'}</p>
          <div class="project-progress">
            <div class="progress-container">
              <div class="progress-bar" style="width: ${progress}%; background: ${project.color};"></div>
            </div>
            <small>${progress}% e përfunduar</small>
          </div>
          <div class="project-meta">
            <span><i class="fas fa-user"></i> ${project.manager || 'Nuk është përcaktuar'}</span>
            <span><i class="fas fa-calendar"></i> ${formatDate(project.start)} - ${formatDate(project.end)}</span>
          </div>
          <div class="project-meta">
            <span class="tag" style="background: ${project.color}">${project.status}</span>
            <div class="task-actions" style="margin-top: 0.5rem;">
              <button class="edit-btn" onclick="editProject(${project.id})"><i class="fas fa-edit"></i></button>
              <button class="delete-btn" onclick="deleteProject(${project.id})"><i class="fas fa-trash-alt"></i></button>
            </div>
          </div>
        </div>
      `;
      
      projectsGrid.appendChild(projectDiv);
    });
  }
  
  function editProject(id) {
    const project = projects.find(p => p.id === id);
    if (!project) return;
    
    document.getElementById("projectName").value = project.name;
    document.getElementById("projectDescription").value = project.description;
    document.getElementById("projectStart").value = project.start;
    document.getElementById("projectEnd").value = project.end;
    document.getElementById("projectManager").value = project.manager;
    document.getElementById("projectStatus").value = project.status;
    document.getElementById("projectColor").value = project.color;
    
    // Remove the project being edited
    projects = projects.filter(p => p.id !== id);
    saveProjects();
    
    showProjectModal();
  }
  
  function deleteProject(id) {
    if (confirm("Jeni i sigurt që dëshironi të fshini këtë projekt?")) {
      projects = projects.filter(p => p.id !== id);
      saveProjects();
    }
  }

  // Dashboard Functions
  function updateDashboard() {
    document.getElementById("totalTasks").textContent = tasks.length;
    document.getElementById("doneTasks").textContent = tasks.filter(t => t.status === "Perfunduar").length;
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("todayTasks").textContent = tasks.filter(t => t.deadline === today).length;
    
    document.getElementById("activeClients").textContent = clients.filter(c => c.status === "Aktiv").length;
    
    // Report stats
    const now = new Date();
    const thisMonth = now.getMonth();
    const thisYear = now.getFullYear();
    
    // Completed tasks this month
    const completedTasks = tasks.filter(t => {
      if (t.status !== "Perfunduar") return false;
      const taskDate = new Date(t.createdAt);
      return taskDate.getMonth() === thisMonth && taskDate.getFullYear() === thisYear;
    }).length;
    document.getElementById("completedTasks").textContent = completedTasks;
    
    // Overdue tasks
    const overdueTasks = tasks.filter(t => {
      if (t.status === "Perfunduar") return false;
      const deadline = new Date(t.deadline);
      return deadline < now;
    }).length;
    document.getElementById("overdueTasks").textContent = overdueTasks;
    
    // Productivity (simple calculation for demo)
    const totalTasks = tasks.length;
    const doneTasks = tasks.filter(t => t.status === "Perfunduar").length;
    const productivity = totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0;
    document.getElementById("productivity").textContent = `${productivity}%`;
    
    // New clients this month
    const newClients = clients.filter(c => {
      const clientDate = new Date(c.added);
      return clientDate.getMonth() === thisMonth && clientDate.getFullYear() === thisYear;
    }).length;
    document.getElementById("newClients").textContent = newClients;
  }

  // Calendar Functions
  
// FIX double calendar rendering
function generateCalendar() {
  const calendarGrid = document.getElementById("calendarGrid");
  const monthNames = ["Janar", "Shkurt", "Mars", "Prill", "Maj", "Qershor", "Korrik", "Gusht", "Shtator", "Tetor", "Nëntor", "Dhjetor"];

  document.getElementById("currentMonth").textContent = `${monthNames[currentMonth]} ${currentYear}`;

  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

  let startDay = firstDay === 0 ? 6 : firstDay - 1;

  // Clear all children except the first 7 headers
  while (calendarGrid.children.length > 7) {
    calendarGrid.removeChild(calendarGrid.lastChild);
  }

  for (let i = 0; i < startDay; i++) {
    const emptyDay = document.createElement("div");
    emptyDay.className = "calendar-day empty";
    calendarGrid.appendChild(emptyDay);
  }

  const today = new Date();
  for (let day = 1; day <= daysInMonth; day++) {
    const dayElement = document.createElement("div");
    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    dayElement.className = "calendar-day";

    if (currentYear === today.getFullYear() && currentMonth === today.getMonth() && day === today.getDate()) {
      dayElement.classList.add("today");
    }

    dayElement.innerHTML = `<div class="calendar-day-header">${day}</div>`;

    const dayTasks = tasks.filter(t => t.deadline === dateStr);
    dayTasks.forEach(task => {
      const taskElement = document.createElement("div");
      taskElement.className = "calendar-task";
      taskElement.textContent = task.title;
      dayElement.appendChild(taskElement);
    });

    calendarGrid.appendChild(dayElement);
  }
}


function prevMonth() {
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    generateCalendar();
  }

  function nextMonth() {
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    generateCalendar();
  }

  function goToToday() {
    const today = new Date();
    currentMonth = today.getMonth();
    currentYear = today.getFullYear();
    generateCalendar();
  }

  // Report Functions
  function generateJSON() {
    const data = {
      tasks: tasks,
      team: team,
      clients: clients,
      projects: projects,
      generated: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(data, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement("a");
    a.href = url;
    a.download = `taskpro-export-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
  
  function generateCSV() {
    alert("Funksioni CSV do të implementohet më vonë");
  }

  function generatePDF() {
    alert("Funksioni PDF do të implementohet më vonë me një bibliotekë si jsPDF");
  }

  function showCharts() {
    const container = document.getElementById("chartsContainer");
    container.style.display = container.style.display === "none" ? "block" : "none";
    
    if (container.style.display === "block") {
      renderCharts();
    }
  }

  function renderCharts() {
    // Status Chart
    const statusCtx = document.getElementById("statusChart").getContext("2d");
    const statusCounts = {
      Planifikuar: tasks.filter(t => t.status === "Planifikuar").length,
      "Ne Proces": tasks.filter(t => t.status === "Ne Proces").length,
      Perfunduar: tasks.filter(t => t.status === "Perfunduar").length
    };
    
    new Chart(statusCtx, {
      type: "pie",
      data: {
        labels: Object.keys(statusCounts),
        datasets: [{
          data: Object.values(statusCounts),
          backgroundColor: [
            "rgba(255, 206, 86, 0.7)",
            "rgba(54, 162, 235, 0.7)",
            "rgba(75, 192, 192, 0.7)"
          ],
          borderColor: [
            "rgba(255, 206, 86, 1)",
            "rgba(54, 162, 235, 1)",
            "rgba(75, 192, 192, 1)"
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
    
    // Priority Chart
    const priorityCtx = document.getElementById("priorityChart").getContext("2d");
    const priorityCounts = {
      "I Lartë": tasks.filter(t => t.priority === "Larte").length,
      "Mesatar": tasks.filter(t => t.priority === "Mesatar").length,
      "I Ulët": tasks.filter(t => t.priority === "Ulet").length
    };
    
    new Chart(priorityCtx, {
      type: "bar",
      data: {
        labels: Object.keys(priorityCounts),
        datasets: [{
          label: "Numri i Detyrave",
          data: Object.values(priorityCounts),
          backgroundColor: [
            "rgba(255, 99, 132, 0.7)",
            "rgba(54, 162, 235, 0.7)",
            "rgba(75, 192, 192, 0.7)"
          ],
          borderColor: [
            "rgba(255, 99, 132, 1)",
            "rgba(54, 162, 235, 1)",
            "rgba(75, 192, 192, 1)"
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
    
    // Timeline Chart
    const timelineCtx = document.getElementById("timelineChart").getContext("2d");
    const dates = [];
    const now = new Date();
    
    // Generate last 30 days
    for (let i = 29; i >= 0; i--) {
      const date = new Date();
      date.setDate(now.getDate() - i);
      dates.push(date.toISOString().split('T')[0]);
    }
    
    const completedData = dates.map(date => {
      return tasks.filter(t => t.status === "Perfunduar" && t.createdAt.split('T')[0] === date).length;
    });
    
    new Chart(timelineCtx, {
      type: "line",
      data: {
        labels: dates.map(d => d.split('-')[2] + '/' + d.split('-')[1]),
        datasets: [{
          label: "Detyrat e Përfunduara",
          data: completedData,
          backgroundColor: "rgba(0, 200, 117, 0.2)",
          borderColor: "rgba(0, 200, 117, 1)",
          borderWidth: 2,
          tension: 0.1,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
    
    // Clients Chart
    const clientsCtx = document.getElementById("clientsChart").getContext("2d");
    const clientStatusCounts = {
      "Aktiv": clients.filter(c => c.status === "Aktiv").length,
      "Pasiv": clients.filter(c => c.status === "Pasiv").length,
      "Potencial": clients.filter(c => c.status === "Potencial").length
    };
    
    new Chart(clientsCtx, {
      type: "doughnut",
      data: {
        labels: Object.keys(clientStatusCounts),
        datasets: [{
          data: Object.values(clientStatusCounts),
          backgroundColor: [
            "rgba(66, 98, 255, 0.7)",
            "rgba(255, 206, 86, 0.7)",
            "rgba(255, 99, 132, 0.7)"
          ],
          borderColor: [
            "rgba(66, 98, 255, 1)",
            "rgba(255, 206, 86, 1)",
            "rgba(255, 99, 132, 1)"
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }

  // Utility Functions
  function formatDate(dateStr) {
    if (!dateStr) return "Nuk është përcaktuar";
    
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return dateStr; // Return raw string if invalid date
    
    return date.toLocaleDateString("sq-AL", {
      year: "numeric",
      month: "short",
      day: "numeric"
    });
  }

  function openFile(base64) {
    const win = window.open();
    win.document.write(`<iframe src="${base64}" style="width:100%;height:100%;border:none;"></iframe>`);
  }

  function kujtoPergjegjesit() {
    const overdueTasks = tasks.filter(t => {
      if (t.status === "Perfunduar") return false;
      
      const deadline = new Date(t.deadline);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      return deadline < today;
    });
    
    if (overdueTasks.length === 0) {
      alert("Nuk ka detyra të vonuara!");
      return;
    }
    
    const uniqueAssignees = [...new Set(overdueTasks.map(t => t.assigned))];
    const message = `Përshendetje! Ju kujtoj për detyrat e vonuara në TaskPro CRM. Ju lutem kontrolloni: ${window.location.href}`;
    
    uniqueAssignees.forEach(assignee => {
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(`Për ${assignee}: ${message}`)}`;
      window.open(whatsappUrl, "_blank");
    });
  }
  
  function switchTaskView(view) {
    if (view === 'kanban') {
      document.getElementById('kanbanView').style.display = 'block';
      document.getElementById('tableView').style.display = 'none';
      document.querySelector('.view-toggle button:first-child').classList.add('active');
      document.querySelector('.view-toggle button:last-child').classList.remove('active');
    } else {
      document.getElementById('kanbanView').style.display = 'none';
      document.getElementById('tableView').style.display = 'block';
      document.querySelector('.view-toggle button:first-child').classList.remove('active');
      document.querySelector('.view-toggle button:last-child').classList.add('active');
    }
  }

  // UI Functions
  function showSection(sectionId) {
    document.querySelectorAll("section").forEach(section => {
      section.classList.remove("active");
    });
    
    document.getElementById(sectionId).classList.add("active");
    
    // Update active nav button
    document.querySelectorAll("nav button").forEach(button => {
      button.classList.remove("active");
    });
    
    event.target.classList.add("active");
    
    // Special handling for certain sections
    if (sectionId === "calendar") {
      generateCalendar();
    } else if (sectionId === "reports") {
      updateDashboard();
    }
  }

  function toggleDarkMode() {
    document.body.classList.toggle("dark");
    localStorage.setItem("darkMode", document.body.classList.contains("dark"));
  }

  function changeTheme(theme) {
    if (theme === "dark") {
      document.body.classList.add("dark");
      localStorage.setItem("darkMode", true);
      localStorage.setItem("theme", "dark");
    } else if (theme === "light") {
      document.body.classList.remove("dark");
      localStorage.setItem("darkMode", false);
      localStorage.setItem("theme", "light");
    } else {
      // System preference
      localStorage.setItem("theme", "system");
      if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
        document.body.classList.add("dark");
        localStorage.setItem("darkMode", true);
      } else {
        document.body.classList.remove("dark");
        localStorage.setItem("darkMode", false);
      }
    }
  }

  function clearAll() {
    if (confirm("Jeni ABSOLUTISHT i sigurt që dëshironi të fshini TË GJITHA të dhënat? Ky veprim nuk mund të zhbëhet!")) {
      localStorage.clear();
      tasks = [];
      team = [];
      clients = [];
      projects = [];
      
      renderTasks();
      renderTeam();
      renderClients();
      renderProjects();
      updateDashboard();
      generateCalendar();
      
      alert("Të gjitha të dhënat janë fshirë!");
    }
  }



// Update project dropdown in task form
function updateProjectSelect() {
  const projectSelect = document.getElementById("taskProject");
  if (!projectSelect) return;

  // Clear previous entries except the default
  while (projectSelect.options.length > 1) projectSelect.remove(1);

  projects.forEach(project => {
    const option = document.createElement("option");
    option.value = project.name;
    option.textContent = project.name;
    projectSelect.appendChild(option);
  });
}

// Modify renderTasks to include project name
const originalRenderTasks = renderTasks;
renderTasks = function() {
  originalRenderTasks();

  document.querySelectorAll(".taskCard").forEach(card => {
    const taskId = parseInt(card.dataset.id);
    const task = tasks.find(t => t.id === taskId);
    if (task && task.project) {
      const projectInfo = document.createElement("small");
      projectInfo.innerHTML = "<strong>Projekti:</strong> " + task.project;
      card.insertBefore(projectInfo, card.children[3]);
    }
  });

  const tableBody = document.getElementById("tasksTableBody");
  if (tableBody) {
    Array.from(tableBody.rows).forEach(row => {
      const task = tasks.find(t => t.title === row.cells[0].textContent);
      if (task && task.project) {
        const cell = document.createElement("td");
        cell.innerHTML = task.project;
        row.insertBefore(cell, row.cells[1]); // insert before "Përgjegjësi"
      } else {
        const cell = document.createElement("td");
        cell.innerHTML = "-";
        row.insertBefore(cell, row.cells[1]);
      }
    });

    // Update table header
    const header = tableBody.parentElement.querySelector("thead tr");
    const newTh = document.createElement("th");
    newTh.textContent = "Projekti";
    header.insertBefore(newTh, header.children[1]);
  }
};

// Store task project on submit
const originalHandleTaskSubmit = handleTaskSubmit;
handleTaskSubmit = async function(e) {
  e.preventDefault();
  const projectSelect = document.getElementById("taskProject");
  const taskProject = projectSelect ? projectSelect.value : "";
  const fileInput = document.getElementById('attachment');
  let fileData = null;

  if (fileInput.files.length > 0) {
    const file = fileInput.files[0];
    fileData = await toBase64(file);
  }

  const task = {
    id: Date.now(),
    title: document.getElementById('title').value,
    description: document.getElementById('description').value,
    deadline: document.getElementById('deadline').value,
    assigned: document.getElementById('assigned').value,
    status: document.getElementById('status').value,
    priority: document.getElementById('priority').value,
    progress: document.getElementById('progress').value,
    tags: document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t),
    file: fileData,
    createdAt: new Date().toISOString(),
    project: taskProject
  };

  tasks.push(task);
  saveTasks();
  e.target.reset();
  document.getElementById('progressBar').style.width = '0%';
  document.getElementById('progressValue').textContent = '0%';
};

document.addEventListener('DOMContentLoaded', updateProjectSelect);



// Populate project filter
function updateProjectFilter() {
  const filterProject = document.getElementById("filterProject");
  if (!filterProject) return;
  while (filterProject.options.length > 1) filterProject.remove(1);
  projects.forEach(project => {
    const option = document.createElement("option");
    option.value = project.name;
    option.textContent = project.name;
    filterProject.appendChild(option);
  });
}

// Extend task filter function
const originalFilterTasks = filterTasks;
filterTasks = function() {
  const projectFilter = document.getElementById("filterProject").value;
  let filteredTasks = [...tasks];

  if (projectFilter) {
    filteredTasks = filteredTasks.filter(t => t.project === projectFilter);
  }

  // apply status/person/priority filters
  const statusFilter = document.getElementById("filterStatus").value;
  const personFilter = document.getElementById("filterPerson").value;
  const priorityFilter = document.getElementById("filterPriority").value;

  if (statusFilter) filteredTasks = filteredTasks.filter(t => t.status === statusFilter);
  if (personFilter) filteredTasks = filteredTasks.filter(t => t.assigned === personFilter);
  if (priorityFilter) filteredTasks = filteredTasks.filter(t => t.priority === priorityFilter);

  const originalTasksBackup = tasks;
  tasks = filteredTasks;
  renderTasks();
  tasks = originalTasksBackup;
};

document.addEventListener('DOMContentLoaded', updateProjectFilter);



// Chart per numrin e detyrave sipas projektit
function renderProjectTaskChart() {
  const ctx = document.getElementById("projectTaskChart");
  if (!ctx) return;

  const projectCounts = {};
  tasks.forEach(task => {
    if (!task.project) return;
    projectCounts[task.project] = (projectCounts[task.project] || 0) + 1;
  });

  const labels = Object.keys(projectCounts);
  const data = Object.values(projectCounts);

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Detyra për Projekt',
        data: data,
        backgroundColor: '#4262ff'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: 'Numri i Detyrave për çdo Projekt'
        }
      }
    }
  });
}

document.addEventListener("DOMContentLoaded", () => {
  if (document.getElementById("projectTaskChart")) renderProjectTaskChart();
});




// Modal për detyra të një projekti
function showProjectTasksModal(projectName) {
  const modal = document.getElementById("projectTasksModal");
  const content = document.getElementById("projectTasksContent");
  content.innerHTML = "";

  const relatedTasks = tasks.filter(t => t.project === projectName);
  if (relatedTasks.length === 0) {
    content.innerHTML = "<p>Nuk ka detyra për këtë projekt.</p>";
  } else {
    relatedTasks.forEach(task => {
      const div = document.createElement("div");
      div.className = "taskCard";
      div.style.marginBottom = "1rem";
      div.innerHTML = `
        <strong>${task.title}</strong><br/>
        <small>Statusi: ${task.status} | Përgjegjës: ${task.assigned} | Afati: ${task.deadline}</small>
        <div class="progress-container" style="margin-top:5px;">
          <div class="progress-bar" style="width:${task.progress}%;"></div>
        </div>
      `;
      content.appendChild(div);
    });
  }

  modal.style.display = "flex";
}

function hideProjectTasksModal() {
  document.getElementById("projectTasksModal").style.display = "none";
}

document.addEventListener("DOMContentLoaded", () => {
  const cards = document.querySelectorAll(".project-card");
  cards.forEach(card => {
    const title = card.querySelector(".project-header h3").innerText;
    card.style.cursor = "pointer";
    card.onclick = () => showProjectTasksModal(title);
  });
});



// Eksporto detyrat e projektit në PDF
function exportProjectTasksToPDF() {
  const project = document.querySelector("#projectTasksModal h2").textContent.replace("Detyrat e Projektit", "").trim() || "Projekt";
  const content = document.getElementById("projectTasksContent");
  const win = window.open("", "", "height=700,width=900");
  win.document.write("<html><head><title>Detyrat e Projektit</title></head><body>");
  win.document.write(`<h2>Detyrat për Projektin: ${project}</h2>`);
  win.document.write(content.innerHTML);
  win.document.write("</body></html>");
  win.document.close();
  win.print();
}

// Eksporto detyrat e projektit në CSV
function exportProjectTasksToCSV() {
  const project = document.querySelector("#projectTasksModal h2").textContent.replace("Detyrat e Projektit", "").trim() || "Projekt";
  const relatedTasks = tasks.filter(t => t.project === project);
  if (relatedTasks.length === 0) return;

  let csv = "Titulli,Statusi,Përgjegjës,Afati,Progresi\n";
  relatedTasks.forEach(t => {
    csv += `"${t.title}","${t.status}","${t.assigned}","${t.deadline}","${t.progress}%"
`;
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `Detyrat_${project}.csv`;
  link.click();
}


function renderOverdueTasks() {
  const container = document.getElementById("overdueTasksContainer");
  const noText = document.getElementById("noOverdueTasks");
  container.innerHTML = "";
  noText.textContent = "";

  const today = new Date().toISOString().split("T")[0];
  const overdue = tasks.filter(t => t.deadline && t.deadline < today && t.status !== "Përfunduar");

  if (overdue.length === 0) {
    noText.textContent = "Nuk ka detyra të vonuara për momentin.";
    return;
  }

  overdue.forEach(task => {
    const div = document.createElement("div");
    div.className = "taskCard veryUrgent";
    div.onclick = () => openModal(task);
    div.innerHTML = `
      <strong>${task.title} <span class='priority-badge'>VONUAR</span></strong>
      <p style='margin: 4px 0;'>Projekti: ${task.project || "Pa emër"}</p>
      <small>Status: ${task.status} | Përgjegjës: ${task.assigned}</small><br/>
      <small style='color:#d9534f;'>Afati ka kaluar: ${task.deadline}</small>
      <div class="progress-container" style="margin-top:5px;">
        <div class="progress-bar" style="width:${task.progress}%; background:#d9534f;"></div>
      </div>
    `;
    container.appendChild(div);
  });
}

function openModal(task) {
  document.getElementById("modalTitle").textContent = task.title;
  document.getElementById("modalDesc").textContent = "Projekti: " + (task.project || "Pa emër");
  document.getElementById("modalFooter").textContent = "Afati: " + task.deadline + " | Status: " + task.status + " | Përgjegjës: " + task.assigned;
  document.getElementById("taskModal").style.display = "block";
}
function closeModal() {
  document.getElementById("taskModal").style.display = "none";
}

document.addEventListener("DOMContentLoaded", () => {
  renderOverdueTasks();
});


// Populate dropdown me emrat e projekteve
function populateProjectFilter() {
  const select = document.getElementById("filterProjectTasks");
  if (!select) return;
  const projects = [...new Set(tasks.map(t => t.project).filter(p => p))];
  projects.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    select.appendChild(opt);
  });
}

// Filter tasks by selected project
function filterTasksByProject() {
  const selectedProject = document.getElementById("filterProjectTasks").value;
  document.querySelectorAll(".task-item").forEach(row => {
    const proj = row.getAttribute("data-project") || "";
    row.style.display = (selectedProject === "" || proj === selectedProject) ? "" : "none";
  });
}

// Inject data-project attribute in each task row
function tagTaskRows() {
  document.querySelectorAll(".task-item").forEach(row => {
    const tId = row.getAttribute("data-id");
    const task = tasks.find(t => t.id === tId);
    if (task && task.project) {
      row.setAttribute("data-project", task.project);
    }
  });
}

document.addEventListener("DOMContentLoaded", () => {
  populateProjectFilter();
  tagTaskRows();
});


// Task modal logic
function openTaskDetail(id) {
  const t = tasks.find(x => x.id === id);
  if (!t) return;
  document.getElementById("detailTitle").textContent = t.title;
  document.getElementById("detailProject").textContent = t.project || "Pa projekt";
  document.getElementById("detailStatus").textContent = t.status;
  document.getElementById("detailAssigned").textContent = t.assigned;
  document.getElementById("detailDeadline").textContent = t.deadline;
  document.getElementById("detailProgressBar").style.width = t.progress + "%";
  document.getElementById("detailModal").style.display = "block";
}

// Connect click to table rows
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".task-item").forEach(row => {
    row.style.cursor = "pointer";
    row.onclick = () => openTaskDetail(row.getAttribute("data-id"));
  });
});


function drawTeamProgressChart() {
  const teamStats = {};
  tasks.forEach(t => {
    const who = t.assigned || "Pa emër";
    if (!teamStats[who]) teamStats[who] = { total: 0, progress: 0 };
    teamStats[who].total += 1;
    teamStats[who].progress += parseInt(t.progress || 0);
  });

  const labels = Object.keys(teamStats);
  const data = labels.map(n => Math.round(teamStats[n].progress / teamStats[n].total));

  const ctx = document.getElementById("teamProgressChart");
  if (!ctx) return;
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: '% Progres Mesatar',
        data: data,
        backgroundColor: '#4caf50'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: { display: true, text: '%' }
        }
      }
    }
  });
}

document.addEventListener("DOMContentLoaded", drawTeamProgressChart);


function exportTasksToExcel() {
  const rows = [["ID", "Titulli", "Projekti", "Përgjegjësi", "Afati", "Status", "Progres"]];
  tasks.forEach(t => {
    rows.push([t.id, t.title, t.project || "", t.assigned || "", t.deadline || "", t.status || "", t.progress + "%"]);
  });

  let csv = rows.map(r => r.join(",")).join("\n");
  let blob = new Blob([csv], { type: "text/csv" });
  let url = URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url;
  a.download = "detyrat.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function showUrgentTasks() {
  const list = document.getElementById("urgentTasksList");
  if (!list) return;

  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(today.getDate() + 1);

  tasks.filter(t => {
    if (!t.deadline || t.status === "Përfunduar") return false;
    const d = new Date(t.deadline);
    return d < today || (d.toDateString() === tomorrow.toDateString());
  }).forEach(t => {
    const li = document.createElement("li");
    li.innerHTML = `<strong>${t.title}</strong> (${t.project || "Pa projekt"}) - Afati: <span style="color:red;">${t.deadline}</span>`;
    list.appendChild(li);
  });
}

document.addEventListener("DOMContentLoaded", showUrgentTasks);


function filterTasksByClient() {
  const selectedClient = document.getElementById("filterClient").value;
  const taskList = document.getElementById("taskList");
  if (!taskList) return;

  taskList.innerHTML = "";
  const projectClients = {};
  projects.forEach(p => {
    if (p.name && p.client) projectClients[p.name] = p.client;
  });

  tasks.forEach(task => {
    const clientName = projectClients[task.project] || "Pa klient";
    if (selectedClient === "të gjithë" || clientName === selectedClient) {
      const li = document.createElement("li");
      li.innerHTML = `<strong>${task.title}</strong> (${task.project}) - ${clientName}`;
      taskList.appendChild(li);
    }
  });
}

function showClientDetails(clientName) {
  document.getElementById("modalClientName").textContent = clientName;

  const projectList = document.getElementById("modalClientProjects");
  const taskList = document.getElementById("modalClientTasks");
  projectList.innerHTML = "";
  taskList.innerHTML = "";

  const clientProjects = projects.filter(p => p.client === clientName);
  clientProjects.forEach(p => {
    const li = document.createElement("li");
    li.textContent = p.name;
    projectList.appendChild(li);
  });

  const projectNames = clientProjects.map(p => p.name);
  tasks.forEach(task => {
    if (projectNames.includes(task.project)) {
      const li = document.createElement("li");
      li.innerHTML = `<strong>${task.title}</strong> (${task.project}) - ${task.assigned}`;
      taskList.appendChild(li);
    }
  });

  $('#clientDetailModal').modal('show');
}

function updateClientStats() {
  const selectedClient = document.getElementById("clientStatsSelect").value;
  const now = new Date().toISOString().split("T")[0];

  const clientProjects = projects.filter(p => p.client === selectedClient);
  const clientProjectNames = clientProjects.map(p => p.name);
  const clientTasks = tasks.filter(t => clientProjectNames.includes(t.project));

  const overdue = clientTasks.filter(t => t.deadline < now && t.status !== "Përfunduar");

  const progressValues = clientTasks.map(t => t.progress || 0);
  const avgProgress = progressValues.length ? Math.round(progressValues.reduce((a,b)=>a+b,0)/progressValues.length) : 0;

  document.getElementById("clientProjectCount").textContent = clientProjects.length;
  document.getElementById("clientTaskCount").textContent = clientTasks.length;
  document.getElementById("clientOverdueCount").textContent = overdue.length;
  document.getElementById("clientAvgProgress").textContent = avgProgress + "%";
}

function checkReminders() {
  const now = new Date();
  const todayStr = now.toISOString().split("T")[0];
  const tomorrow = new Date(now);
  tomorrow.setDate(now.getDate() + 1);
  const tomorrowStr = tomorrow.toISOString().split("T")[0];

  let alertList = [];
  tasks.forEach(task => {
    if (task.status !== "Përfunduar") {
      if (task.deadline === todayStr) {
        alertList.push("📌 Skadon SOT: " + task.title);
      }
      if (task.deadline === tomorrowStr) {
        alertList.push("⏳ Skadon NESËR: " + task.title);
      }
      if (task.deadline < todayStr) {
        alertList.push("⚠️ E VONUAR: " + task.title);
      }
    }
  });

  if (alertList.length > 0) {
    const alertText = alertList.join("\n");
    alert("🔔 Kujtesë Detyrash:\n\n" + alertText);
  }
}
window.addEventListener("load", checkReminders);
setInterval(checkReminders, 60000); // Every 60s


function updateClientSelect() {
  const clientDropdown = document.getElementById("projectClient");
  if (!clientDropdown) return;
  clientDropdown.innerHTML = `<option value="">Zgjidh klientin</option>`;
  clients.forEach(client => {
    const option = document.createElement("option");
    option.value = client.name;
    option.textContent = client.name;
    clientDropdown.appendChild(option);
  });
}



function handleClientSubmit(e) {
  e.preventDefault();
  const client = {
    name: document.getElementById("clientName").value,
    contact: document.getElementById("clientContact").value,
    phone: document.getElementById("clientPhone").value,
    email: document.getElementById("clientEmail").value,
    status: document.getElementById("clientStatus").value,
    source: document.getElementById("clientSource").value
  };

  clients.push(client);
  localStorage.setItem("clients", JSON.stringify(clients));
  renderClients();
  alert("Klienti u shtua me sukses!");
}

</script>
<!-- Modal për detyrat e një projekti -->
<div id="projectTasksModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; justify-content:center; align-items:center;">
<div style="background:white; max-width:800px; width:90%; padding:2rem; border-radius:12px; overflow-y:auto; max-height:90vh;">
<div style="display:flex; justify-content:space-between; align-items:center;">
<h2>Detyrat e Projektit</h2>
<button onclick="hideProjectTasksModal()" style="font-size:1.2rem;">×</button>
</div>
<div style="margin-bottom: 1rem;">
<button class="export-btn" onclick="exportProjectTasksToPDF()">📄 Eksporto PDF</button>
<button class="export-btn" onclick="exportProjectTasksToCSV()">📥 Eksporto CSV</button>
</div>
<div id="projectTasksContent" style="margin-top:1rem;"></div>
</div>
</div>
<div class="modal" id="detailModal">
<div class="modal-content">
<span class="modal-close" onclick="document.getElementById('detailModal').style.display='none'">×</span>
<h3 id="detailTitle"></h3>
<p><strong>Projekti:</strong> <span id="detailProject"></span></p>
<p><strong>Statusi:</strong> <span id="detailStatus"></span></p>
<p><strong>Përgjegjësi:</strong> <span id="detailAssigned"></span></p>
<p><strong>Afati:</strong> <span id="detailDeadline"></span></p>
<p><strong>Progresi:</strong></p>
<div style="background:#ddd; border-radius:5px; overflow:hidden; height:14px; margin-bottom:10px;">
<div id="detailProgressBar" style="background:#28a745; height:100%; width:0%;"></div>
</div>
<p><strong>📝 Komente:</strong> <span style="color:gray">(placeholder – pa ruajtje ende)</span></p>
<textarea placeholder="Shkruaj komentin këtu..." style="width:100%; height:80px;"></textarea>
<button style="margin-top:10px;">💬 Shto koment</button>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js">

function updateClientSelect() {
  const clientDropdown = document.getElementById("projectClient");
  if (!clientDropdown) return;
  clientDropdown.innerHTML = `<option value="">Zgjidh klientin</option>`;
  clients.forEach(client => {
    const option = document.createElement("option");
    option.value = client.name;
    option.textContent = client.name;
    clientDropdown.appendChild(option);
  });
}



function handleClientSubmit(e) {
  e.preventDefault();
  const client = {
    name: document.getElementById("clientName").value,
    contact: document.getElementById("clientContact").value,
    phone: document.getElementById("clientPhone").value,
    email: document.getElementById("clientEmail").value,
    status: document.getElementById("clientStatus").value,
    source: document.getElementById("clientSource").value
  };

  clients.push(client);
  localStorage.setItem("clients", JSON.stringify(clients));
  renderClients();
  alert("Klienti u shtua me sukses!");
}

</script>
<!-- Client Detail Modal -->
<div aria-hidden="true" aria-labelledby="clientDetailLabel" class="modal fade" id="clientDetailModal" role="dialog" tabindex="-1">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Detaje për Klientin: <span id="modalClientName"></span></h5>
<button class="close" data-dismiss="modal" type="button">×</button>
</div>
<div class="modal-body">
<h6>📁 Projektet:</h6>
<ul id="modalClientProjects"></ul>
<h6>✅ Detyrat:</h6>
<ul id="modalClientTasks"></ul>
</div>
</div>
</div>
</div>
<script>
function allowDrop(ev) {
  ev.preventDefault();
}

function drag(ev) {
  ev.dataTransfer.setData("text", ev.target.id);
}

function drop(ev) {
  ev.preventDefault();
  var data = ev.dataTransfer.getData("text");
  var task = document.getElementById(data);
  if (!task) return;
  if (ev.target.classList.contains('kanban-column')) {
    ev.target.appendChild(task);
  } else if (ev.target.closest('.kanban-column')) {
    ev.target.closest('.kanban-column').appendChild(task);
  }
}


function updateClientSelect() {
  const clientDropdown = document.getElementById("projectClient");
  if (!clientDropdown) return;
  clientDropdown.innerHTML = `<option value="">Zgjidh klientin</option>`;
  clients.forEach(client => {
    const option = document.createElement("option");
    option.value = client.name;
    option.textContent = client.name;
    clientDropdown.appendChild(option);
  });
}



function handleClientSubmit(e) {
  e.preventDefault();
  const client = {
    name: document.getElementById("clientName").value,
    contact: document.getElementById("clientContact").value,
    phone: document.getElementById("clientPhone").value,
    email: document.getElementById("clientEmail").value,
    status: document.getElementById("clientStatus").value,
    source: document.getElementById("clientSource").value
  };

  clients.push(client);
  localStorage.setItem("clients", JSON.stringify(clients));
  renderClients();
  alert("Klienti u shtua me sukses!");
}

</script><script>
    let dailyTasks = JSON.parse(localStorage.getItem("dailyTasks")) || [];

    function renderDailyTasks() {
      const filter = document.getElementById("filterByPerson").value;
      const plan = document.getElementById("daily-plan");
      const proc = document.getElementById("daily-process");
      const done = document.getElementById("daily-done");

      [plan, proc, done].forEach(c => c.innerHTML = "");

      const people = new Set();
      dailyTasks.forEach(task => people.add(task.person));
      const select = document.getElementById("filterByPerson");
      select.innerHTML = `<option value="">Të gjithë</option>`;
      [...people].forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        select.appendChild(opt);
      });

      dailyTasks.forEach(task => {
        if (filter && task.person !== filter) return;
        const div = document.createElement("div");
        div.className = "kanban-task";
        div.draggable = true;
        div.ondragstart = e => e.dataTransfer.setData("text", task.id);
        div.innerHTML = `${task.title} <small>👤 ${task.person}</small>`;
        div.onclick = () => editDailyTask(task.id);
        if (task.status === "Planifikuar") plan.appendChild(div);
        else if (task.status === "Ne Proces") proc.appendChild(div);
        else if (task.status === "Perfunduar") done.appendChild(div);
      });
    }

    function showTaskForm() {
      document.getElementById("dailyTitle").value = "";
      document.getElementById("dailyPerson").value = "";
      document.getElementById("dailyStatus").value = "Planifikuar";
      document.getElementById("editTaskId").value = "";
      document.getElementById("dailyTaskModal").style.display = "block";
    }

    function closeTaskModal() {
      document.getElementById("dailyTaskModal").style.display = "none";
    }

    function saveDailyTask() {
      const title = document.getElementById("dailyTitle").value.trim();
      const person = document.getElementById("dailyPerson").value.trim();
      const status = document.getElementById("dailyStatus").value;
      const id = document.getElementById("editTaskId").value;
      if (!title || !person) return alert("Plotësoni fushat!");
      if (id) {
        const idx = dailyTasks.findIndex(t => t.id == id);
        saveActionSnapshot();
    dailyTasks[idx] = { id, title, person, status };
      } else {
        saveActionSnapshot();
        dailyTasks.push({ id: Date.now().toString(), title, person, status });
      }
      localStorage.setItem("dailyTasks", JSON.stringify(dailyTasks));
      closeTaskModal();
      renderDailyTasks();
    }

    function editDailyTask(id) {
      const t = dailyTasks.find(t => t.id == id);
      document.getElementById("dailyTitle").value = t.title;
      document.getElementById("dailyPerson").value = t.person;
      document.getElementById("dailyStatus").value = t.status;
      document.getElementById("editTaskId").value = t.id;
      document.getElementById("dailyTaskModal").style.display = "block";
    }

    function allowDrop(ev) {
      ev.preventDefault();
    }

    function dropTask(ev, newStatus) {
      ev.preventDefault();
      const id = ev.dataTransfer.getData("text");
      const task = dailyTasks.find(t => t.id == id);
      if (task) {
        saveActionSnapshot();
    task.status = newStatus;
        localStorage.setItem("dailyTasks", JSON.stringify(dailyTasks));
        renderDailyTasks();
      }
    }

    window.addEventListener("load", renderDailyTasks);
  </script><script>
let actionHistory = JSON.parse(localStorage.getItem("actionHistory")) || [];

function saveActionSnapshot() {
  actionHistory.push(JSON.stringify(dailyTasks));
  if (actionHistory.length > 30) actionHistory.shift();
  localStorage.setItem("actionHistory", JSON.stringify(actionHistory));
}

function undoLastAction() {
  if (actionHistory.length === 0) {
    alert("Nuk ka veprime për të kthyer pas.");
    return;
  }
  const lastState = actionHistory.pop();
  dailyTasks = JSON.parse(lastState);
  localStorage.setItem("dailyTasks", JSON.stringify(dailyTasks));
  localStorage.setItem("actionHistory", JSON.stringify(actionHistory));
  renderDailyTasks();
}
</script><script>
function exportActionHistory() {
  const data = localStorage.getItem("actionHistory");
  if (!data) return alert("Nuk ka historik për të eksportuar.");
  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "Historiku_Detyrave.json";
  a.click();
  URL.revokeObjectURL(url);
}
</script><script>
function generateCalendarWithData() {
  const calendarGrid = document.getElementById("calendarGrid");
  calendarGrid.innerHTML = "";

  const today = new Date();
  const dayNames = ["E Hënë", "E Martë", "E Mërkurë", "E Enjte", "E Premte", "E Shtunë", "E Diel"];

  for (let i = 0; i < 7; i++) {
    const current = new Date(today);
    current.setDate(today.getDate() + i);
    const yyyy_mm_dd = current.toISOString().split("T")[0];
    const dayName = dayNames[current.getDay() === 0 ? 6 : current.getDay() - 1];

    const dayBox = document.createElement("div");
    dayBox.className = "calendar-day";
    if (i === 0) dayBox.classList.add("today");

    const header = document.createElement("div");
    header.className = "calendar-day-header";
    header.innerHTML = `${dayName}<br>${current.toLocaleDateString("sq")}`;
    dayBox.appendChild(header);

    // Add daily tasks
    dailyTasks.filter(t => {
      const tDate = new Date(parseISODate(t.date || t.deadline));
      return tDate.toDateString() === current.toDateString();
    }).forEach(task => {
      const div = document.createElement("div");
      div.className = "calendar-task";
      div.textContent = "📝 " + task.title;
      div.title = "Përgjegjës: " + task.person + " | Status: " + task.status;
      dayBox.appendChild(div);
    });

    // Add regular tasks
    tasks.filter(t => {
      const tDate = new Date(parseISODate(t.deadline));
      return tDate.toDateString() === current.toDateString();
    }).forEach(task => {
      const div = document.createElement("div");
      div.className = "calendar-task";
      div.textContent = "✅ " + task.title;
      div.title = "Përgjegjës: " + task.assigned + " | Status: " + task.status + " | Prioritet: " + task.priority;
      dayBox.appendChild(div);
    });

    // Add projects
    projects.filter(p => {
      const pDate = new Date(parseISODate(p.projectEnd));
      return pDate.toDateString() === current.toDateString();
    }).forEach(proj => {
      const div = document.createElement("div");
      div.className = "calendar-task";
      div.textContent = "🏗️ " + proj.projectName;
      div.title = "Klient: " + proj.client + " | Menaxher: " + proj.projectManager;
      dayBox.appendChild(div);
    });

    calendarGrid.appendChild(dayBox);
  }
}

function parseISODate(dateStr) {
  return typeof dateStr === "string" ? new Date(dateStr) : new Date();
}

window.addEventListener("load", generateCalendarWithData);
</script><section id="asistenti-personal" style="display:none;"><body>
<h1>🧠 Asistent Personal</h1>
<div class="summary" id="summary">Duke ngarkuar detyrat...</div>
<div class="task-list" id="todayTasks"></div>
<script>
    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString("sq-AL", { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function loadTasksForToday() {
      const dailyTasks = JSON.parse(localStorage.getItem("dailyTasks") || "[]");
      const generalTasks = JSON.parse(localStorage.getItem("tasks") || "[]");
      const today = new Date().toISOString().split("T")[0];

      const all = [...dailyTasks.map(t => ({...t, type: "daily"})), ...generalTasks.map(t => ({...t, type: "general"}))];

      const filtered = all.filter(task => {
        const d = task.deadline || task.date;
        return d && d.startsWith(today);
      });

      filtered.sort((a, b) => {
        const p = { "Larte": 1, "Mesatar": 2, "Ulet": 3 };
        return (p[a.priority || "Mesatar"] - p[b.priority || "Mesatar"]);
      });

      const list = document.getElementById("todayTasks");
      const summary = document.getElementById("summary");
      summary.innerHTML = `📅 Sot ke <strong>${filtered.length}</strong> detyra për t’u përmbushur.`;

      list.innerHTML = "";
      filtered.forEach(task => {
        const div = document.createElement("div");
        const prio = (task.priority || "Mesatar").toLowerCase();
        div.className = `task-card ${prio}`;
        const status = task.status || "Planifikuar";
        const person = task.assigned || task.person || "—";
        const tagClass = prio === "larte" ? "tag-high" : prio === "mesatar" ? "tag-medium" : "tag-low";
        div.innerHTML = `
          <h3>${task.title}</h3>
          <small>👤 ${person}</small>
          <small>📌 Status: ${status}</small>
          <small>🕒 Afat: ${formatDate(task.deadline || task.date)}</small>
          <span class="tag ${tagClass}">${task.priority || "Mesatar"}</span>
        `;
        list.appendChild(div);
      });
    }

    window.addEventListener("load", loadTasksForToday);
  
    // Narrator me zë
    function speakTasks(tasks) {
      const synth = window.speechSynthesis;
      let text = "Sot ke " + tasks.length + " detyra. ";
      tasks.forEach((t, i) => {
        text += `Detyra ${i+1}: ${t.title}. Statusi: ${t.status || "Planifikuar"}.`;
      });
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "sq-AL";
      synth.speak(utterance);
    }

    // Push Notification
    function notifyTasks(tasks) {
      if (!("Notification" in window)) return;
      if (Notification.permission !== "granted") {
        Notification.requestPermission();
      }
      tasks.forEach(t => {
        const n = new Notification("📌 Detyrë e Ditës", {
          body: t.title + " | " + (t.status || "Planifikuar"),
        });
      });
    }

    // Zbatimi i përmirësimeve sapo faqja të ngarkohet
    window.addEventListener("load", () => {
      const dailyTasks = JSON.parse(localStorage.getItem("dailyTasks") || "[]");
      const generalTasks = JSON.parse(localStorage.getItem("tasks") || "[]");
      const today = new Date().toISOString().split("T")[0];
      const all = [...dailyTasks.map(t => ({...t, type: "daily"})), ...generalTasks.map(t => ({...t, type: "general"}))];
      const filtered = all.filter(task => {
        const d = task.deadline || task.date;
        return d && d.startsWith(today);
      });
      speakTasks(filtered);
      notifyTasks(filtered);
    });
</script>
<script>
    function saveUpdatedTasks(tasks) {
      const general = tasks.filter(t => t.type === "general");
      const daily = tasks.filter(t => t.type === "daily");
      localStorage.setItem("tasks", JSON.stringify(general));
      localStorage.setItem("dailyTasks", JSON.stringify(daily));
    }

    // Shfaq kartat me komandat e reja
    function renderTasksWithControls(tasks) {
      const list = document.getElementById("todayTasks");
      list.innerHTML = "";
      tasks.forEach((task, i) => {
        const div = document.createElement("div");
        const prio = (task.priority || "Mesatar").toLowerCase();
        div.className = `task-card ${prio}`;
        const tagClass = prio === "larte" ? "tag-high" : prio === "mesatar" ? "tag-medium" : "tag-low";
        const status = task.status || "Planifikuar";
        const person = task.assigned || task.person || "—";

        div.innerHTML = `
          <h3>${task.title}</h3>
          <small>👤 ${person}</small>
          <small>📌 Status: ${status}</small>
          <small>🕒 Afat: ${formatDate(task.deadline || task.date)}</small>
          <span class="tag ${tagClass}">${task.priority || "Mesatar"}</span><br><br>
          <button onclick="markDone(${i})">✅ E kryer</button>
          <button onclick="deleteTask(${i})">❌ Hiqe</button><br><br>
          <textarea id="comment-${i}" rows="2" placeholder="Shënime...">${task.comment || ""}</textarea>
        `;
        list.appendChild(div);
      });
    }

    function markDone(index) {
      const allTasks = JSON.parse(localStorage.getItem("allTasksToday") || "[]");
      allTasks[index].status = "Përfunduar";
      allTasks[index].done = true;
      allTasks[index].comment = document.getElementById("comment-" + index).value;
      saveUpdatedTasks(allTasks);
      alert("Detyra u shënua si e përfunduar.");
      location.reload();
    }

    function deleteTask(index) {
      const allTasks = JSON.parse(localStorage.getItem("allTasksToday") || "[]");
      allTasks.splice(index, 1);
      saveUpdatedTasks(allTasks);
      alert("Detyra u fshi.");
      location.reload();
    }

    function rescheduleIncomplete(tasks) {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tStr = tomorrow.toISOString().split("T")[0];
      tasks.forEach(t => {
        if (t.status !== "Përfunduar") {
          if (t.deadline) t.deadline = tStr;
          else if (t.date) t.date = tStr;
        }
      });
      saveUpdatedTasks(tasks);
    }

    window.addEventListener("load", () => {
      const dailyTasks = JSON.parse(localStorage.getItem("dailyTasks") || "[]");
      const generalTasks = JSON.parse(localStorage.getItem("tasks") || "[]");
      const today = new Date().toISOString().split("T")[0];
      const all = [...dailyTasks.map(t => ({...t, type: "daily"})), ...generalTasks.map(t => ({...t, type: "general"}))];
      const filtered = all.filter(task => {
        const d = task.deadline || task.date;
        return d && d.startsWith(today);
      });

      // Ruaj për akses të brendshëm
      localStorage.setItem("allTasksToday", JSON.stringify(all));

      document.getElementById("summary").innerHTML = `📅 Sot ke <strong>${filtered.length}</strong> detyra për t’u përmbushur.`;
      renderTasksWithControls(filtered);
      speakTasks(filtered);
      notifyTasks(filtered);

      // Shtyje automatikisht detyrat e papërfunduara për nesër
      rescheduleIncomplete(all);
    });
  </script>
</body></section><script>
    function showSection(id) {
      const sections = document.querySelectorAll("section");
      sections.forEach(s => s.style.display = "none");
      const sec = document.getElementById(id);
      if (sec) sec.style.display = "block";
    }
    </script><script>
function setLanguage(lang) {
  document.querySelectorAll('[data-en]').forEach(el => {
    el.innerText = lang === 'en' ? el.getAttribute('data-en') : el.getAttribute('data-sq');
  });
  localStorage.setItem('language', lang);
}
window.addEventListener('DOMContentLoaded', () => {
  const savedLang = localStorage.getItem('language') || 'sq';
  setLanguage(savedLang);
  const selector = document.querySelector('select[onchange*="setLanguage"]');
  if (selector) selector.value = savedLang;
});
</script></body>
</html>